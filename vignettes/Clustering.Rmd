---
title: "Clustering"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Clustering}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

# Setup
```{r setup}
library(multiAnalysis)
set.seed(123)
set_analysis(block_name = "clinic_still_processed", to_remove = c("1007", "1014"))
hc_method <- "ward.D2"
hc_metric <- "spearman"
hc_index <- "silhouette"
k <- 2
n_boot <- 1000
MAX_CLUSTERS <- 10
colors_k <- get_colors()[seq(k) + 2]
```

# Data preparation
```{r formatting, eval = FALSE}
# Levels
row_annotation <- data.frame(Disease = disease)
names_levels <- levels(disease)

# names_levels <- c("Still", "Control", "SOJIA")

vars2 <- c("immun_aid_identifier", "weight", "height") # , "fatigue")
blocks <- blocks %>% select(
    -c(
        vars2,
        # ends_with("_global_assessment"),
        ends_with("_upper_limit_of_normal"),
        starts_with("max_"),
        "disease"
    )
)
# select(-c("eye_manifestations", "cardiac_manifestations")) # %>%
# select(-c("gender", "BMI", "age_at_inclusion_time", "batch"))
colnames(blocks) <- colnames(blocks) %>%
    tools::toTitleCase() %>%
    gsub("_", " ", .)
```

```{r}
if (block_name == "t_biol")
blocks <- blocks %>% select(starts_with("V1")) %>% set_colnames(colnames(.) %>% str_remove_all("V1\\.")) %>% select(-c(`Conjugated bilirubin`, `Neutrophils %`, `Erythrocyte sedimentation rate`, `ASAT ULN`, `Alk phosphatases ULN`, `Max CRP`, `Ferritin`, SAA, ends_with(" ULN")))

if (block_name == "t_aidai") {
  blocks <- apply(blocks, 2, function(x) (x == 0) %>% `!` %>% which() %>% length()) %>% `>`(2) %>% which() %>% select(blocks, .)
}

if (block_name == "t_muscu") {
  blocks <- apply(blocks, 2, function(x) sum(x, na.rm = TRUE))  %>% `>`(2) %>% which() %>% select(blocks, .)
}
  
# Remove individuals with high levels of NA
res <- sapply(rownames(blocks), function(i) round((length(which(is.na(blocks[i, ]))) / ncol(blocks)) * 100, 1))
# names(res) <- clinic_intersect$immun_aid_identifier
plotHistogram(df = res, cex = 1.5) 
res0 <- sapply(rownames(blocks), function(i) (length(which(blocks[i, ] > 0))))
plotHistogram(df = res0, cex = 1.5, rows = ncol(blocks)) -> p
# list.map(list(2:4, 5:7, 8:ncol(blocks)), f(x) ~ {
#   sapply(rownames(blocks), function(i) (length(which(select(blocks, x)[i, ] > 0)))) %>%
#   plotHistogram(df = ., cex = 1.5, ratio = 7, rows = ncol(blocks))
# }) ->p2
#     plot_grid(
#         plotlist = c(list(p), p2),
#         align = "hv",
#         nrow = 1,
#         ncol = 4
#     )
# res1 <- sapply(rownames(blocks), function(i) (sum(blocks[i, ], na.rm = TRUE))) 
# plot_violin0(res1, colour = "red", size = 3, pch_colour = "black", pch_alpha = 0.5, title = "")
# name_inds <- names(res[res > 50])
# clinic_intersect %>% filter(str_detect(immun_aid_identifier, paste0("^", name_inds, "$", collapse = "|"))) %>% select(immun_aid_identifier, disease) -> temp
# name_lvls <- levels(clinic_intersect$disease)[unique(temp$disease) %>% sort()]
# table(temp$disease)
# res[res > 50]
if (block_name == "t_muscu") {
    # blocks <-  slice(blocks, -which(res0 < 2))
} else {
    blocks <- blocks[-which(res == 100), ]
}

res_scaled_na <- scale0(blocks, method = "minmax")

# if (block_name == "t_aidai") {
#   blocks[blocks == 0] <- NA
# }

# Scaling
res_scaled <- scale0(blocks)
```

# Optimal k
```{r, eval = FALSE}
get_clust_tendency(res_scaled, n = nrow(res_scaled) - 1)

index <- c(
    "kl", "ch", "hartigan", "cindex", "db", "silhouette", "duda", "pseudot2",
    "beale", "ratkowsky", "ball", "ptbiserial", "gap", "frey",
    "mcclain", "gamma", "gplus", "tau", "dunn", "hubert",
    "sdindex", "dindex", "sdbw", "all", "alllong"
)

res.nbclust <- NbClust(
    data = res_scaled,
    # diss = res_dist,
    min.nc = 2, max.nc = 10,
    method = hc_method,
    index = hc_index
)

# fviz_nbclust(res.nbclust)

# fviz_nbclust(
#     res_scaled,
#     get_clusters,
#     method = hc_index
# )
# (gaps <- clusGap(
#     res_scaled,
#     FUN = get_clusters,
#     K.max = 6,
#     B = n_boot
# ))
# fviz_gap_stat(gaps, maxSE = list(method = "Tibs2001SEmax", SE.factor = 1))
```

# Distance
```{r}
res_dist <- get_dist0(res_scaled, method = hc_metric)

# fviz_dist(
#     res_dist,
#     gradient = list(
#         low = colors_ind[1],
#         mid = colors_ind[2],
#         high = colors_ind[3]
#     )
# )
```

# Clustering
```{r}
# res_clus <- HCPC(pca_res, nb.clust = k, graph = FALSE)
# res_clus$data.clust$clust
# res_clus$desc.var$test.chi2

# group <- hclust(res_dist, method = hc_method) %>%
#     cutree(k = k)
# table(group, disease)

res_clus <- eclust(
    res_scaled,
    "hclust",
    hc_method = hc_method,
    stand = FALSE,
    hc_metric = hc_metric,
    k = k
)
table(res_clus$cluster, t(row_annotation))

res_clus_var <- res_scaled %>%
    t() %>%
    eclust(
        "hclust",
        hc_method = hc_method,
        stand = FALSE,
        hc_metric = hc_metric,
        k = k
    )
```

# Visualisation
```{r}
rownames(row_annotation) <- rownames(res_scaled)
n <- seq(length(names_levels))
row_col <- get_colors()[n]
names(row_col) <- names_levels
row_col0 <- as.character(factor(disease, labels = get_colors()[seq(n)]))

fviz_dend(
    res_clus,
    k = k,
    rect = TRUE,
    # rect_fill = TRUE,
    k_colors = colors_k,
    color_labels_by_k = TRUE,
)

res0 <- pvclust(
    t(res_scaled),
    method.hclust = hc_method,
    method.dist = "correlation",
    use.cor = "pairwise.complete.obs",
    nboot = n_boot,
    parallel = TRUE
) %>% suppressWarnings()
plot_dendrogram(res0, k = k, color = colors_k, row_col0)
# save_tiff(plot_dendrogram(res0, k = k), filename = "clust_tot.temp.tiff")

# print(res0, digits = 3)
# pvpick(res0)

# plot(res_clus, choice = "3D.map")

# plotDendrogram(2, row_dend0, res_scaled, MAX_CLUSTERS, cls[[k-1]])

fviz_cluster(
    res_clus,
    repel = TRUE,
    show.clust.cent = TRUE,
    palette = colors_k,
    ggtheme = theme_minimal(),
    main = "Factor map",
    ellipse.type = "norm"
) + theme_classic()

# dl <- dendlist(
#     color_dendrogram(d1, 2, get_colors()[c(3, 5) + 9]),
#     color_dendrogram(d2, 2, get_colors()[c(3, 5) + 9])
# )
# tanglegram(
#     dl,
#     # common_subtrees_color_lines = FALSE,
#     highlight_branches_lwd = FALSE,
#     highlight_distinct_edges = FALSE,
#     # k_branches = 2,
#     # k_labels = 2,
#     lwd = 2
# )
```

# Heatmap
```{r}
row_dend <- color_dendrogram(res_clus, k = k, colors = colors_k) %>% sort()
col_dend <- color_dendrogram(res_clus_var, k = 2, colors = c("#f03088", "#d9d52c")) %>% sort()

heatmaply(
    res_scaled_na,
    # k_col = k,
    # k_row = k,
    colors = colors_ind,
    na.value = "black",
    # distfun = hc_metric,
    # hclust_method = hc_method,
    Rowv = row_dend,
    Colv = col_dend,
    # row_dend_left = TRUE
    # seriate = "mean",
    # col_side_colors = group_code,
    row_side_colors = row_annotation,
    row_side_palette = row_col,
    RowSideColors = disease,
    plot_method = "plotly",
    colorbar_xpos = 1.025,
    fontsize_row = 15,
    fontsize_col = 15,
    # na.rm = FALSE,
    key.title = "Disease"
    # side_color_layers,
) %>% layout(xaxis = list(ticklen = 0), yaxis2 = list(ticklen = 0))

row_dend0 <- res_scaled %>%
    get_dist0(method = hc_metric) %>%
    hclust(method = hc_method)

col_dend0 <- res_scaled %>%
    t() %>%
    get_dist0(method = hc_metric) %>%
    hclust(method = hc_method)

pheatmap(
    res_scaled_na,
    color =  colorRampPalette(colors_ind)(100),
    angle_col = 315,
    na_col = "white",
    annotation_row = row_annotation,
    border_color = NA,
    annotation_colors = list(Disease = row_col),
    # annotation_col = my_sample_col,
    cluster_rows = row_dend0,
    cluster_cols = col_dend0,
    cutree_rows = k,
    cutree_cols = k,
    fontsize = 12
)

heatmap(
    as.matrix(res_scaled_na),
    col = colorRampPalette(colors_ind)(100),
    scale = "none",
    na.rm = FALSE,
    # na_col = "black",
    RowSideColors = row_col0,
    Rowv = row_dend,
    Colv = col_dend
)

# clinic_intersect %>% filter(str_detect(disease, "control")) %>%
#     arrange(immun_aid_identifier)
```

# Quality
```{r}
# plotGapPerPart(gaps, MAX_CLUSTERS)
plotFusionLevels(MAX_CLUSTERS, row_dend0)
cls <- getClusterPerPart(MAX_CLUSTERS, row_dend0)
get_summary(res_dist, cls, MAX_CLUSTERS, row_dend0, k = k) %>% round(2) %>% kable0()
plot_silhouette0(res_dist, cls, k, colors_k = get_colors()[seq(k)])

# Variable contribution
100 * getCtrVar(k, cls[[k - 1]], res_scaled)
ctr <- getDiscriminantVariables(k, cls[[k - 1]], res_scaled, ncol(blocks))
# rownames(ctr) <- str_sub(rownames(ctr), 1, 40) %>% to_any_case(unique_sep = NULL, parsing_option = 3)
plotHistogram(df = ctr, cex = 1.5, dec = 0, ratio = 4)
# round(ctr[, 1, drop = FALSE], 2)

# x = blocks; res = sapply(seq(nrow(x)), function(i) round((length(which(is.na(x[i, ]))) / ncol(x))*100, 1))
#  names(res) <- rownames(blocks[[1]])
# plotHistogram(df = res, hjust = -0.4) +
#     geom_hline(yintercept = c(35), col = "red")

cl <- cls[[k - 1]]
n <- 6
# blocks0 <- blocks
# var <- c("alat", "asat", "ggt")
# colnames(blocks0) <- to_any_case(colnames(blocks0), unique_sep = NULL, parsing_option = 3)
# colnames(blocks0)[colnames(blocks0) %in% var] <- toupper(var)

stats <- as.data.frame(blocks) %>%
    cbind(cl = as.character(cl)) %>%
    calculate_test1(method = "kruskal") %>% 
    arrange(p)
filter(stats, p <= 0.05) %>% select(-c(" ")) %>% kable0()
filter(stats, p <= 0.05) %>% pull(Variables) %>% list.map(f(x) ~ select(blocks, x) %>% mutate(cl = cl) %>% group_by(cl) %>% group_split() %>% as.list() %>% list.map(f(i) ~ pull(i, x)) %>% list_cbind() %>% set_colnames(paste0("G", seq(length(unique(cl))))) %>% plot_violin0(method = "kruskal", colour = get_colors()[seq(length(unique(cl)))], size = 3, pch_colour = "black", pch_alpha = 0.5, ylab = x, title = "", wrap = 10)) %>%
    plot_grid(
        plotlist = .,
        align = "hv",
        nrow = 2,
        ncol = 3
    )

filter(stats, p <= 0.05) %>% pull(Variables) %>% list.map(f(x, y, z) ~ select(blocks, x) %>% mutate(cl = cl) %>% set_colnames(c("name", "cl")) %>% dunn_test(name ~ cl, p.adjust.method = "BH") %>% filter(p <= .05))

filter(stats, p <= 0.05) %>% pull(Variables) %>% list.map(f(x) ~ select(blocks, x) %>% mutate(cl = cl) %>% group_by(cl) %>% group_split() %>% as.list() %>% list.map(f(i) ~ pull(i, x)) %>% list_cbind() %>% set_colnames(paste0("G", seq(3))) %>% get_melt() %>% dunn_test(value ~ name, p.adjust.method = "BH") %>% add_xy_position(x = "group"))

data("t_general")

t_general0 <- t_general %>% mutate(immun_aid_identifier = rownames(.) %>% as.double()) %>% left_join(select(clinic_intersect, age_at_inclusion_time, immun_aid_identifier)) %>% rename(`Age at inclusion time` = age_at_inclusion_time)
blocks0 <- blocks %>% mutate(immun_aid_identifier = rownames(.) %>% as.double()) %>% left_join(t_general0) %>% select(c(colnames(t_general0), -c(immun_aid_identifier, `In how many months?`, `Weight loss (kg)`)))
as.data.frame(blocks0) %>%
    cbind(cl = as.character(cl)) %>%
    calculate_test1(method = "kruskal") %>% 
    arrange(p)

confonding <- list.map(
  select(blocks0, -c("Max (°C)", "Number of consecutive days")),
  cor_test0(blocks, ., method = "spearman") %>% print_cor() %>% filter(p <= 0.05)
)

list.map(
  rownames(confonding$`Age at inclusion time`),
f(x, y) ~ plot_cor2(data_frame(pull(blocks, x), pull(blocks0, "Age at inclusion time")) %>% set_colnames(c(x, "Age at inclusion time")), method = "spearman", color = get_colors()[-c(6, 7)][y])
)%>%
    plot_grid(
        plotlist = .,
        align = "hv",
        nrow = 2,
        ncol = 3
    )

list.map(colnames(select(blocks0, -c("Max (°C)", "Number of consecutive days"))), f(x) ~ select(blocks0, x) %>% mutate(cl = cl) %>% group_by(cl) %>% group_split() %>% as.list() %>% list.map(f(i) ~ pull(i, x)) %>% list_cbind() %>% set_colnames(paste0("G", seq(length(unique(cl))))) %>% plot_violin0(method = "kruskal", colour = get_colors()[seq(length(unique(cl)))], size = 3, pch_colour = "black", pch_alpha = 0.5, ylab = x, title = "")) %>%
    plot_grid(
        plotlist = .,
        align = "hv",
        nrow = 2,
        ncol = 2
    )

plot_mean_test(dat, "physician_global_assessment", as_tibble(stats), colors_k)

n <- 8
(descr <- pivot_longer(dat, !cl) %>%
    group_by(name, cl) %>%
    summarise(
        mean = mean(value, na.rm = TRUE),
        sd = sd(value, na.rm = TRUE),
        n = length(which(!is.na(value)))
    ) %>%
    # filter(str_detect(name, paste(names(var0), collapse= "|")))  %>%
    pivot_wider(names_from = cl, values_from = c(mean, sd, n))
)

stats %>%
    as_tibble() %>%
    arrange(p) %>%
    filter(p < 0.05) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance(p.col = "p.adj")

# for (i in as.data.frame(vars)[-c(7, 11, 12), 1]) group_by((data.frame(x = dat[, i], cl)), cl) %>% mutate(log_d = (x)) %>% shapiro_test(x) %>% print()

ctr2 <- tibble(name = rownames(ctr), ctr = ctr[, 1])
stats2 <- stats %>%
    as_tibble() %>%
    select(all_of(c("name", "p", "p.signif")))
tot <- Reduce(left_join, list(ctr2, descr, stats2)) # %>% arrange(p)
tot <- tot %>%
    filter(p < 0.05) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance(p.col = "p.adj")
tot$p <- format(tot$p, scientific = TRUE, digits = 2)
tot$p.adj <- format(tot$p.adj, scientific = TRUE, digits = 2)
arrange(tot, desc(ctr)) %>%
    # slice(seq(n)) %>%
    select(-c(starts_with("n_"), contains("sd_"), "p", "p.signif"))

vars <- c("batch", "gender", "patient_ethnicity", "age_at_inclusion_time")
t_conf <- blocks %>% 
  mutate(immun_aid_identifier = rownames(.) %>% as.double()) %>% 
  left_join(select(clinic_intersect, c(vars, immun_aid_identifier))) %>% 
  select(-c(immun_aid_identifier, colnames(blocks))) %>% 
  mutate(
    batch = as.factor(batch),
    age_at_inclusion_time = ifelse(age_at_inclusion_time >= 18, "Adult", "Children")
  )
  chi2_test(cl, t_conf, method = "fisher")

confonding1 <- list.map(
  select(t_conf, -1),
  f(i) ~ as.data.frame(blocks) %>%
      cbind(cl = as.character(i)) %>%
      calculate_test1(method = "wilcox") %>% 
      arrange(p) %>%
    filter(p <= 0.05)
)
# pairwise_fisher_test(table(tab))

list.map(
  confonding1[1:2], 
  f(x, xtt, xt) ~ {
    pull(x, Variables) %>% list.map(
      f(y) ~ {
select(blocks, y) %>% mutate(cl = pull(t_conf, xt)) %>% group_by(cl) %>% group_split() %>% as.list() %>% list.map(f(i) ~ pull(i, 1)) %>% list_cbind() %>% set_colnames(pull(t_conf, xt) %>% levels()) %>% plot_violin0(method = "wilcox", colour = sapply(c(25, 75), function(j) col2hcl(get_colors()[xtt], l = j)), size = 3, pch_colour = "black", ylab = y, pch_alpha = 0.5, title = "", wrap = 10)
})
}) -> p
plot_grid(
    plotlist = c(p[[1]], list(NULL), p[[2]]),
    align = "hv",
    nrow = 2,
    ncol = 4
)
    
confonding1[[4]] <- as.data.frame(blocks[-19, ]) %>%
  cbind(cl = as.character(pull(t_conf, batch)[-19])) %>%
  calculate_test1(method = "wilcox") %>% 
  arrange(p) %>%
  filter(p <= 0.05)

pull(confonding1[[4]], Variables) %>% list.map(
      f(y) ~ {
select(blocks[-19, ], y) %>% mutate(cl = pull(t_conf, batch)[-19]) %>% group_by(cl) %>% group_split() %>% as.list() %>% list.map(f(i) ~ pull(i, 1)) %>% list_cbind() %>% set_colnames(paste0("Batch", c(2, 3))) %>% plot_violin0(method = "wilcox", colour = c(get_colors()[3], alpha(get_colors()[3],  alpha = 0.25)), size = 3, pch_colour = "black", ylab = y, pch_alpha = 0.5, title = "", wrap = 10)
}) %>%
  plot_grid(
        plotlist = .,
        align = "hv",
        nrow = 1,
        ncol = 3
    )

confonding0 <- list.map(
  vars[-1], 
f(i) ~ as.data.frame(blocks) %>%
    cbind(cl = as.character(pull(tab, i))) %>%
    calculate_test1(method = "wilcox") %>% 
    arrange(p) %>%
  filter(p <= 0.05)
)

as.data.frame(blocks[-19, ]) %>%
    cbind(cl = as.character(pull(tab, 1)[-19])) %>%
    calculate_test1(method = "wilcox") %>% 
    arrange(p) %>%
    filter(p <= 0.05) %>% kable0()

plotHistogram(df = ctr) +
    labs(subtitle = expression(paste("Fisher test for count data (2,32), ", italic("p"), " = ", "<0.0001"))) +
    theme(plot.subtitle = element_text(size = 15, hjust = 0.5, face = "italic", color = "black"))

# Outputs
# write.csv2(as.data.frame(cl), "clusters.temp.tsv")
```

# NHC
```{r}
classif <- getClassif(2, MAX_CLUSTERS, res_scaled, res_dist)
# res_dist0 <- get_dist(res_scaled, stand = FALSE, method = "euclidian")
# classif <- lapply(2:MAX_CLUSTERS, function(i) pam(res_dist0, i, diss = TRUE))
classif[[k]]$data <- res_scaled
cls <- getClusterPerPart(MAX_CLUSTERS, classif)
get_summary(res_dist, cls, MAX_CLUSTERS, k = k)

fviz_cluster(
    classif[[k]],
    data = res_scaled,
    repel = TRUE,
    show.clust.cent = TRUE,
    palette = colors_k,
    ggtheme = theme_minimal(),
    main = "Factor map",
    ellipse.type = "norm"
) + theme_classic()
```
