---
title: "DSeq2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DSeq2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Metadata
```{r, eval = FALSE}
library("readxl")
blocks0 <- lapply(
    seq(2),
    function(x) {
      read_excel(
        file.path(path, "Still treatments V1 and V2 24NOV2023.xlsx"),
        skip = 1,
        sheet = x
        ) %>% set_colnames(
          colnames(.) %>%
            str_remove_all("([Pp]atients)|(under)") %>% 
            str_trim() %>%
            str_replace_all("Nsaids", "NSAIDs") %>%
            str_replace_all("a(nti)", "A\\1-") %>%
            str_replace_all("GCs", "Corticosteroid")
          )
          }
        )

emna_treat <- lapply(
    seq(2),
    function(x) {
      apply(blocks0[[x]][, -1], 2, function(x) is.na(x) %>% `!` %>% as.numeric())  %>%
      as.data.frame() %>% 
      mutate(
        Other = (`Other...10` == 1 | `Other...11` == 1) %>% as.numeric(),
        ID = blocks0[[x]]$`Patient ID`) %>% 
      relocate(ID, 1) %>%
      select(-matches("(Other...)|(global)")) %>%
      # select(-c("Colchicine", "Anti-TNF")) %>%
      column_to_rownames("ID")
    }
) %>% set_names(paste0("V", seq(2)))
use_data(emna_treat, overwrite = TRUE)

tmp <- lapply(
  seq(2),
  function(i) {
    tmp0 <- blocks0[[i]]$Other...11 %>% unique() %>% na.omit()
blocks0[[i]]$Other...10[nrow(blocks0[[i]]):(nrow(blocks0[[i]]) - length(tmp0) + 1)] <- tmp0
  lapply(
  blocks0[[i]][, -seq(3)] %>% 
  mutate(Other = `Other...10`) %>% 
    select(-matches(c("TNF", "Other..."))),
  function(x) {
    sapply(
      x,
      function (y) {
    tmp <- str_split(y, " ") %>% 
          pluck(1) %>% 
          str_remove_all(":") %>%
          str_replace_all("Pracetamol", "Paracetamol")
    if (is.na(tmp[[1]])) {
      c(NA, NA)
    } else {
      c(tmp[[1]], paste(tmp[2:length(tmp)], collapse = " "))
    }
      }
    ) %>% set_colnames(blocks0[[i]]$`Patient ID`)
    }
  )
  }
)

# i <- 1
names(tmp[[i]]) %>%  
  lapply(function(x) tmp[[i]][[x]][1, ] %>% fct_count() %>% arrange(desc(n))) %>%
  set_names(names(tmp[[i]]))

# tmp[[1]]$NSAIDs[, "1001"] <- c("Methylprednisone", "Partial response")
ifelse(blocks0[[2]]$`Patient global situation` == "Complete remission", 1, 0)
# Response
y <- 2
responses0 <- names(tmp[[i]]) %>%  
    lapply(function(x)
        tmp[[i]][[x]][y, ] %>% 
        str_replace_all(".*(artial).*", "P\\1") %>% 
            str_replace_all(".*nkn?own", "Unknown") %>% 
               str_replace_all(".*(omplete).*", "C\\1") %>% 
               GimmeMyPlot:::to_title()
           ) %>% 
  list.cbind() %>%
  set_colnames(names(tmp[[i]])) %>%
  as.data.frame() %>%
  select(-contains("global"))
responses0 <- apply(responses0, 2, function(x) na.omit(x) %>% length()) %>%
  sort(TRUE) %>% 
  names() %>% 
  select(responses0, .)
responses0[responses0 == "Response"] <- "Unknown"
responses0[responses0 == "Unknown"] <- NA
responses0 <- mutate(responses0, ID = blocks0[[1]]$`Patient ID`)
responses <- gather(responses0, "treatment", "response", -ID) %>%
    relocate("response", .before = 1)

response_levels <- c("Complete", "Partial", "Loss of efficacy", "No response")

responses %>%
  filter(!is.na(response)) %>%
  GimmeMyPlot:::plot_bar_2cat(
    threshold = 1,
    method = "fisher",
    colour1 = c("red", brewer.pal(4, "Greens")[-1]) %>% rev(),
    legend = response_levels,
    workspace = 1e8
)

responses1 <- full_join(t_responses_v1, t_drugs_v1, by = c("ID", "treatment"))
filter(responses1, treatment == "Anti-IL1") %>%
    # filter(ID %in% GC_aIL1) %>% 
    rename(response = "response.x") %>% 
    rename(drug = "response.y") %>%
    filter(!is.na(response)) %>%
    select(-c(ID, treatment)) %>%
  GimmeMyPlot:::plot_bar_2cat(
    # threshold = 1,
    method = "fisher",
    colour1 = c("red", brewer.pal(4, "Greens")[-1]) %>% rev() %>% .[-c(3)],
    legend = response_levels[-c(3)],
    workspace = 1e8
) -> p00

responses %>% 
    filter(!is.na(response)) %>% 
    GimmeMyPlot:::post_hoc_chi2(method = "fisher") %>%
    arrange(desc(p))

# Response per drugs
# t_responses_v1 <- responses0 %>% set_rownames(blocks0[[1]]$`Patient ID`)
# data("list_treat")
list.map(
  colnames(get(paste0("t_drugs_v", i))),
  f(x) ~{
  cbind(select(get(paste0("t_responses_v", i)), x), select(get(paste0("t_drugs_v", i)), x)) %>%
    set_colnames(c("Response", "Drugs")) %>% 
    filter(!is.na(Drugs)) %>%
    plot_alluvial() +
      ggtitle(x) +
      theme(
        axis.text.x = element_blank(),
        axis.title = element_blank()
        )
  }) %>%
  plot_grid(
    plotlist = .,
    nrow = 2,
    ncol = 3,
    align = "hv"
)

j <- 1
for (i in rev(response_levels)) {
  t_responses_v1[t_responses_v1 == i] <- j
  j <- j + 1
}
t_responses_v1 <- t_responses_v1 %>% 
  apply(2, as.numeric) %>%
  as.data.frame() %>%
  mutate(Naive = ifelse(emna_treat[[2]]$Naive == 1, 1, 0)) %>%
  set_rownames(rownames(emna_treat[[2]])) %>%
  select(order_resp)

order_resp <- t_responses_v1 %>%
  apply(2, function(x) na.omit(x) %>% length()) %>% 
  sort(TRUE) %>% names()

for (i in rev(order_resp)) {
  t_responses_v1 <- arrange(t_responses_v1, desc(!!sym(i)))
}

t_responses_v1 %>%
  mutate(ID = rownames(.)) %>%
gather("treatment", "Response", -ID) %>%
  mutate(treatment = factor(treatment, levels = order_resp)) %>%
    ggplot(aes(ID, treatment, fill = Response)) + 
    geom_tile() +
    scale_fill_manual(
      values = c("black", "red", brewer.pal(4, "Greens")[-1]),
      na.value = "grey",
      labels = c(rev(response_levels), "No treatment")
    ) +
    theme_classic() +
    theme(
        axis.title = element_blank(),
        axis.text.x = element_text(size = 10, color = "grey"),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_text(size = 20, color = "grey"),
        legend.title = element_text(face = "bold.italic", size = 25),
        legend.text = element_text(size = 17, color = "grey")
    )

y_type <- list(aIL1, GC)
y_type <- list(GC_aIL1, GC_aIL1)
# Name of drugs per type of treatment
names(tmp[[i]]) %>% 
  keep(function(x) str_detect(x, "(IL1|Cortico)")) %>%
  # discard(function(x) str_detect(x, "IL6")) %>%
  list.map(f(x, y) ~ {
    tmp0 <- tmp[[i]][[x]][1, ]
    tmp0[tmp0 == "Response"] <- NA
    tmp0 <- tmp0[y_type[[y]]]
    plot_pie(tmp0, title = x)
  }) -> p2

plot_grid(
    plotlist = c(p, p2),
    nrow = 2,
    ncol = 2,
    align = "hv",
    byrow = FALSE
)

# Most frequent drugs
list.map(
  seq(2),
  f(i, j) ~ {
per_drug_types <- names(tmp[[i]]) %>% 
  discard(function(x) str_detect(x, "Patient")) %>%
    lapply(function(x) tmp[[i]][[x]][1, ])
tmp1 <- unlist(per_drug_types) %>%
  na.omit()
n <- fct_infreq(tmp1) %>%
            fct_rev() %>%
  fct_count() %>% 
  filter(n > 1) %>% 
  arrange(n) %>%
  pull(f)
cols <- list.mapv(
  n,
  f(x) ~ {
    list.which(
    per_drug_types, f(y) ~ {
    if(all(is.na(y))){
      FALSE
    }  else {
      str_detect(x, y) %>% any()
      }
    })
  }
)
plot_bar_mcat(
  tmp1, 
  n_max = length(n), 
  colour = GimmeMyPlot:::palette_discrete()[cols],
  title = paste0("V", j)
  )
}) %>%
plot_grid(
    plotlist = .,
    nrow = 2,
    align = "hv",
    rel_heights = c(2, 1)
)

# Most frequent treatment types
cols <- c(1, 1, "#E41A1C", "#BAE4B3", "#238B45", "#74C476", "#984EA3", "#FF7F00",  "#F781BF")

list.map(
  seq(2),
  f(i, j) ~{
tmp1 <- emna_treat[[i]] %>%
  apply(2, sum)
cols0 <- data.frame(cols, tmp1) %>% filter(tmp1 > 0) %>% arrange(desc(tmp1))
plot_bar(
  select(cols0, tmp1), 
  sample_size = nrow(emna_treat[[i]]), 
  threshold = 1, 
  colour = pull(cols0, cols),
  title = paste0("V", j)
  )
}) %>%
  plot_grid(
    plotlist = .,
    nrow = 2,
    align = "hv"
)

emna_treat[[i]] %>%
  select(-c("Colchicine", "Anti-TNF", "Naive")) %>% 
  apply(2, function(x) ifelse(x == 0, "No", "Yes")) %>%
  plot_alluvial()

# blocks1[[1]][c(naive, GC_V1, aIL1_V1), ] %>%
#   select(c("Corticosteroid", "Naive", "Anti-IL1")) %>% 
#   apply(2, function(x) ifelse(x == 0, "No", "Yes")) %>%
#   plot_alluvial()
```

# Setup
```{r setup}
library("multiAnalysis")
library("tximport")
library("enrichplot")
library("ggupset")
library("sva")
# library(ggVennDiagram)
# cwd <- golem::get_golem_wd()
path <- file.path(cwd, "inst", "extdata")
set_analysis(block_name = "emna_treat", type = "list", cwd = cwd)

data("clinic")
blocks <- clinic %>%
  filter(!str_detect(C_2643_3798, "(suspi)|(angiosarcoma)|(Crohn)")) %>% set_rownames(pull(., "C_2643_3796") %>% as.numeric())
control <- filter(clinic, str_detect(C_2643_3798, "control")) %>% pull(C_2643_3796) %>% as.numeric()

batch_df <- read_tsv(file.path(path, "batch_rna.tsv")) %>% arrange(Sample)
batches <-  filter(batch_df, str_detect(Sample, "A"))
batches <- pull(batches, 2) %>% set_names(pull(batches, 1) %>% str_remove_all("A05PB\\d") %>% as.numeric())

gender <- clinic$C_2649_3888 %>% set_names(as.numeric(clinic$C_2643_3796))
age <- clinic$C_2643_3803 %>% set_names(as.numeric(clinic$C_2643_3796))
# disease_duration <- interval(
#     (complete_date(clinic$C_2648_3887) %>% dmy()),
#     (complete_date(clinic$C_2643_3802) %>% dmy())
# ) %>%
#   divide_by(years(1)) %>% 
#   set_names(as.numeric(clinic$C_2643_3796))

setEnrichrSite("Enrichr")
dbs <- c("GO_Molecular_Function_2021", "GO_Biological_Process_2021", "Orphanet_Augmented_2021", "WikiPathway_2021_Human", "MSigDB_Hallmark_2020", "Reactome_2022")
organism <- "org.Hs.eg.db"
library(organism, character.only = TRUE)
```

# Load gene count data
```{r}
# Load the count matrix
counts_matrix <- read_tsv(file = file.path(path, "gene_counts.tsv"))
# ids <- colnames(counts_matrix)[-1] %>% str_remove_all("[AB]05PB\\d") %>% as.numeric()
# batch_df0 <- batch_df %>% pull(2) %>% set_names(pull(batch_df, 1))
# batch_df0 <- batch_df0[colnames(counts_matrix)[-1]]
# counts_matrix0 <- as.matrix(counts_matrix[, -1]) %>%
#     set_rownames(pull(counts_matrix, 1)) %>%
#     ComBat_seq(batch_df0) %>%
#     as.data.frame()
# counts_combatseq <- mutate(counts_matrix0, gene_id = pull(counts_matrix, gene_id)) %>%
#   relocate(gene_id)
# use_data(counts_combatseq, overwrite = TRUE)
# data(counts_combatseq)
# counts_matrix <- counts_combatseq[, -1] %>% round() %>% as.matrix() %>% vst() %>% as.data.frame() %>% mutate(gene_id = pull(counts_combatseq, gene_id)) %>% relocate(gene_id)
```

# Extract visits and intersect common rows between data
```{r}
# counts_matrix <- transcript_counts
# Split the visits
l_visits <- list.map(
    c("A", "B"),
    f(i) ~ {
        str_detect(colnames(counts_matrix), paste0("^(\\d{5})", i)) %>%
            which() %>%
            c(1, .) %>%
            select(counts_matrix, .)
    }
)

# Formatting the patient names
col_names <- list.map(l_visits, f(.) ~ {
    colnames(.)[-1] %>%
        str_remove_all("(A|B)05PB\\d") %>%
        as.numeric() %>%
        sort()
})

# Select visit A, rename columns, order by patient ID
l_visits <- list.map(
    c("A", "B"),
    f(i) ~ {
        set_colnames(l_visits[[i]], colnames(l_visits[[i]]) %>% str_replace_all(paste0("0?(\\d{4})(A|B)05PB\\d"), "\\1")) %>%
            select(c("gene_id", as.character(col_names[[i]])))
    }
)
# list.map(c("A", "B"), f(i) ~ l_visits[[i]] %>% select(intersect(colnames(.), rownames(blocks))) %>% ncol() %>% rep(i, .)) %>% unlist() %>% unname() %>% plot_piechart(cex = 30, hsize = 1.5, title = "", label = FALSE, colour = brewer.pal(9, "Paired")[7:8])
counts_matrix <- l_visits[["A"]]
gene_name <- str_remove_all(counts_matrix$gene_id, "\\.*")
# Filter by common rows
# common_rows <- Reduce(intersect, list(colnames(counts_matrix), c(sapply(blocks, rownames) %>% unlist(), control), names(batches)))
common_rows <- Reduce(intersect, list(colnames(counts_matrix), c(rownames(blocks), control), names(batches)))
counts_matrix <- lapply(l_visits, function(i) select(i, matches(paste0("^", common_rows, "$", collapse = "|")))) %>% list.cbind() %>% select(-contains("gene_id"))

blocks <- blocks %>% mutate(ID = rownames(.)) %>% filter(ID %in% common_rows) %>% select(-ID)
# blocks <- list.map(blocks, f(i) ~ i %>% mutate(ID = rownames(.)) %>% filter(ID %in% common_rows) %>% select(-ID)) # %>% select(contains(c("Mucocutaneous", "Musculoskeletal", "Urticaria", "Myocarditis", "Anti-IL1", "Anti-IL6", "Corticosteroid", "DMARDs", "Kinase.Inhibitor", "Naive")))

# treat_v2 <- treat_v2 %>% mutate(ID = rownames(.)) %>% filter(ID %in% common_rows) %>% select(-ID) 

# c(list.map(l_visits, f(i) ~ colnames(i)[-1]), CLINIC = list(rownames(blocks)))
# plot_venn1(temp, color = c("#FED976", "#FD8D3C", "#377EB8"))
# blocks %>% mutate(Biologic = Anti.IL1 + Anti.IL6) %>% select(c(3:5, 7)) %>% plot_bar_mcat(colors = get_colors()[c(seq(3), 5)], title = "") -> p
# select(blocks, seq(2)) %>% plot_bar_mcat(colors = brewer_pal(, "YlGn")(9)[c(4, 8)], title = "") -> p2
# blocks0 %>% select(c(1, 3)) %>% mutate(id = rownames(.)) -> df
# blocks %>% select(c(2:3)) %>% mutate(id = rownames(.)) -> df2
```

# Join gene counts with the annotation
```{r}
data("gene_query")
counts_matrix <- mutate(counts_matrix, ensembl_gene_id = gene_name) %>%
    left_join(gene_query) %>%
    arrange(hgnc_symbol) %>%
    # select(-ensembl_gene_id) %>%
    data.frame() %>%
    filter(!str_detect(hgnc_symbol, "^$"))
gene_hgnc <- pull(counts_matrix, hgnc_symbol) %>%
    snakecase::to_any_case(case = "none", sep_in = NULL, unique_sep = "_")
counts_matrix <- select(counts_matrix, -c(hgnc_symbol)) %>%
    set_colnames(colnames(counts_matrix)[-c(ncol(counts_matrix))] %>% str_remove_all("^X")) %>%
    set_rownames(gene_hgnc)
# use_data(counts_matrix, overwrite = TRUE)

filtered_counts <- counts_matrix[apply(select(counts_matrix, -ensembl_gene_id), 1, sum) > 10, ]
ensembl_ids <- pull(filtered_counts, ensembl_gene_id)
filtered_counts <- select(filtered_counts, -ensembl_gene_id) %>% round()
```

# Annotation query
```{r, eval = FALSE}
db_annot <- useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl", version = 104)
# datasets <- listDatasets(db_annot)
# filter(datasets, str_detect(description, "Human")) %>% pull(version)

gene_query <- getBM(
    attributes = c("ensembl_gene_id", "hgnc_symbol"),
    filters = c("ensembl_gene_id", "transcript_biotype", "chromosome_name"),
    values = list(gene_name, "protein_coding", seq(22)),
    mart = db_annot
)

# gene_query <- read_tsv(file = file.path(path, "martquery.tsv")) %>% set_colnames(c("ensembl_gene_id", "hgnc_symbol"))
# which(is.na(gene_query$`Gene name`)) %>% length()
gene_query[duplicated(gene_query$ensembl_gene_id) %>% which(), ] %>%
    pull(ensembl_gene_id) %>%
    paste0("^", ., "$") %>%
    list.map(., f(i) ~ filter(gene_query, str_detect(ensembl_gene_id, i)))

duplicates <- gene_query[duplicated(gene_query$ensembl_gene_id) %>% which(), 1]
gene_query <- gene_query[!gene_query$ensembl_gene_id %in% duplicates, ] %>% rbind(data.frame(ensembl_gene_id = c("ENSG00000276085"), hgnc_symbol = c("CCL3L1/3")))
use_data(gene_query, overwrite = TRUE)
```

```{r, eval = FALSE}
```{r}
# blocks <- filter(blocks, !str_detect(C_2643_3798, "Negative"))
# blocks <- lapply(
#     c(TRUE, FALSE),
#     function(x) filter(blocks, str_detect(C_2643_3798, "(AOSD)|(SOJIA)", negate = x)) %>% pull("C_2643_3796") %>% as.numeric() %>% unique()
# ) %>%
blocks <- lapply(
    # c("control", "(AOSD)|(SOJIA)"),
    c("^((?!(AOSD)|(SOJIA)).)*$", "(AOSD)|(SOJIA)"),
    # c("control", "osteitis"),
    function(x) filter(blocks, str_detect(C_2643_3798, x)) %>% pull("C_2643_3796") %>% as.numeric() %>% unique()
) %>%
    list.map(f(i, k) ~ data.frame(id = i, group = factor(k - 1))) %>%
    list.rbind() %>%
    arrange(id) %>%
    mutate(batch = batches[names(batches) %in% id] %>% factor()) %>%
    mutate(gender = gender[names(gender) %in% id] %>% factor()) %>%
    mutate(age = age[names(age) %in% id] %>% factor()) %>%
    # mutate(disease_duration = disease_duration[names(disease_duration) %in% id] %>% factor()) %>%
    set_rownames(pull(., id) %>% paste0("A.", .)) %>%
    select(-id) %>%
    list() %>%
    set_names("Control vs Disease")
```

```{r, eval = FALSE}
blocks1 <- blocks

GC_aIL1 <- filter(blocks[[1]], Corticosteroid == 1 & `Anti-IL1` == 1 & `Anti-IL6` != 1 & `NSAIDs` != 1 & `DMARDs` != 1 & `Other` != 1  & `Anti-TNF` != 1) %>%
    rownames()
naive <- filter(blocks[[1]], Naive == 1) %>%
    rownames()
treated <-  filter(blocks[[1]], Naive != 1) %>%
    rownames()
GC <- filter(blocks[[1]], Corticosteroid == 1 & `Anti-IL1` != 1 & `Anti-IL6` != 1 & `NSAIDs` != 1 & `DMARDs` != 1 & `Other` != 1 & `Anti-TNF` != 1) %>%
    rownames()
aIL1 <- filter(blocks[[1]], Corticosteroid != 1 & `Anti-IL1` == 1 & `Anti-IL6` != 1 & `NSAIDs` != 1 & `DMARDs` != 1 & `Other` != 1 & `Anti-TNF` != 1) %>%
    rownames()

batches <- batches[common_rows]
control <- control[control %in% common_rows]
blocks <- list.map(list(control, naive), f(i, k) ~ data.frame(id = i, group = factor(k - 1))) %>%
    list.rbind() %>%
    arrange(id) %>%
    set_rownames(pull(., id) %>% paste0("A.", .)) %>%
    mutate(batch = batches[names(batches) %in% id] %>% factor()) %>%
    select(-id) %>%
    list()

blocks[2:4] <- list.map(
  c("GC", "aIL1", "GC_aIL1"), 
  f(x) ~ {
  list.map(list(naive, get(x)), f(i, k) ~ data.frame(id = i, group = factor(k - 1))) %>%
    list.rbind() %>%
    arrange(id) %>%
    set_rownames(pull(., id) %>% paste0("A.", .)) %>%
    mutate(batch = batches[names(batches) %in% id] %>% factor()) %>%
    select(-id)
})

blocks[[5]] <- list.map(
    list(naive, treated),
    f(i, j) ~ {
    data.frame(id = i, group = factor(j - 1)) %>% 
      arrange(id) %>%
      set_rownames(pull(., id) %>% paste0("A.", .)) %>%
      mutate(batch = batches[names(batches) %in% id] %>% factor()) %>% 
      select(-id)
  }) %>% list.rbind()

blocks <- set_names(
  blocks, 
  c(
    "Control vs Naive",
    c("GCs", "aIL1", "GCs+aIL1") %>% paste("Naive vs", ., "Non-responder"),
    "Naive vs Treated"
  )
)
```

# DGEA
```{r}
# setA <- select(counts_matrix, which(groups == 0) %>% names())
# setB <- select(counts_matrix, which(groups == 1) %>% names())
# comparison <- cbind(setA, setB)
# exprs_threshold <- 1 * NCOL(counts_matrix)
l_de0 <- list.map(blocks, f(i, j) ~ {
  countData <- filtered_counts %>% select(rownames(i))
    DESeqDataSetFromMatrix(
        countData = countData,
        colData = i,
        design = ~ batch + group
    ) %>% DESeq()
})
# results() %>%
l_de <- list.map(l_de0, f(i) ~ lfcShrink(i, coef = "group_1_vs_0") %>%
    as.data.frame())
# rownames_to_column(l_de[[1]], "geneName") %>% write_tsv(file.path(path, "dgea_ctr_still_batch5.tsv"))
# list.map(
#   l_de,
#   f(x, y, z) ~ rownames_to_column(x, "geneName") %>% write_tsv(file.path(path, paste0("dgea_still_batch4_", str_to_lower(z) %>% snakecase::to_any_case("none"), ".tsv")))
# )
```

# Volcano plot
```{r}
fc_threshold = 1
p_threshold = 0.001
l_de2 <- list.map(l_de, f(i) ~ i %>%
    mutate(ensembl_ids = ensembl_ids, log2fc = log2FoldChange, p = pvalue, log10p = -log(padj, 10), name = rownames(.) %>% str_remove_all("_\\d*") %>% toupper(), Expression = case_when(
        log2FoldChange >= fc_threshold & padj <= p_threshold ~ "Up-regulated",
        log2FoldChange <= -fc_threshold & padj <= p_threshold ~ "Down-regulated",
        TRUE ~ "ns"
    )) %>%
    filter(log2FoldChange >= 0.01 | log2FoldChange <= -0.01)
)

# list.map(l_de2, f(i, k, j) ~ i %>%
#     volcano_plot(cex = 3, legend = "none") + xlab("") + ylab("")) -> p
# list.map(p, f(i, j, k) ~{
#     save_tiff(i, file.path(path_img, paste0("volcano_", k, ".tiff")), 4000, 3000)
# })
# top_genes <- list(
#     c("IFI44", "MX1", "USP18", "FOXO3", "MCL1", "PTGS2", "VEGFA"),
#     c("FAM13A"),
#     c("KBTBD11", "TNF", "LIPA", "RAD52", "HCN3"),
#     c("FCGR1A", "HIF1A", "ICAM1", "SOD2", "TNFAIP6", "CD3D", "CD3E", "CD3G", "CD8A", "LCK"),
#     c("BCL6", "IL10", "VEGFA")
# )
top_genes <- list.map(l_de2, get_top0(., fc_threshold = fc_threshold, p = p_threshold, n = 15))
list.map(l_de2, f(i, j, k) ~ volcano_plot(i, top_genes = top_genes[[j]], cex = 1, legend = "none", title = k, fc_threshold = fc_threshold, p_threshold = p_threshold) + xlab("") + ylab("")) -> p2
# for (pl in names(p2)) {
#     save_tiff(p2[[pl]], file.path(path_img, paste0("volcano2_", pl, ".tiff")), 4000, 3000)
# }

# list(pluck(., 1), pluck(., 2), NULL, pluck(., 3), pluck(., 4)) %>%
# list(pluck(., 1), NULL, NULL, pluck(., 2)) %>%
plot_grid(
    plotlist = p2,
    nrow = 2,
    ncol = 3,
    align = "hv"
)
#     save_tiff(file.path(path_img, "volcano_treat2"), 8000, 4000)
```

# Descriptive statistics
```{r, eval = FALSE}
get_top(l_de2[[5]], 2, 0.05, n = 200) %>%
    mutate(rank_p = rank(desc(log10p)), rank_fc = rank(desc(abs(log2FoldChange)))) %>%
    mutate(rank = rank(rank_p + rank_fc)) %>%
    arrange(rank)

list.map(l_de, f(i) ~ filter(i, !is.na(padj)) %>%
    filter(log2FoldChange >= 1 | log2FoldChange <= -1) %>%
    filter(padj <= 0.05) %>%
    arrange(padj))

de_gene_names <- list.map(l_de, f(i) ~ mutate(i, log2fc = log2FoldChange) %>%
    filter(!is.na(padj)) %>%
    filter(!str_detect(rownames(.), "unknown")) %>%
    get_top(0.5, 1) %>%
    rownames() %>%
    str_remove_all("_\\d") %>%
    unique() %>%
    toupper())

res <- results(l_de0[[4]])
summary(res)
as.data.frame(res) %>%
    arrange(log2FoldChange) %>%
    head()

without_unknown <- res %>%
    as.data.frame() %>%
    filter(!str_detect(rownames(.), "unknown"))
(de_genes <- res %>% as.data.frame() %>% arrange(padj) %>% filter(padj <= 0.05))

de_gene_names <- de_genes %>%
    rownames() %>%
    str_remove_all("_\\d") %>%
    unique() %>%
    toupper()
de_genes_ranked <- without_unknown$log2FoldChange %>%
    set_names(rownames(without_unknown) %>% str_remove_all("_\\d*") %>% toupper()) %>%
    sort(decreasing = TRUE)
# plotMA(res, alpha = 0.05, colSig = "red", ylim = 3 * c(-1, 1))
res %>%
    as.data.frame() %>%
    arrange(desc(log2FoldChange)) %>%
    head()
i <- 2
plot_count <- function(i, gene = gene, cex = 1.5, colour = get_colors()[c(5, 3)], ...) {
    name <- str_split(names(blocks)[i], " vs ")[[1]]
    tmp0 <- l_de2[[i]] %>% filter(rownames(.) == gene)
    subtitle <- paste0(
      "P = ", 
      tmp0 %>% pull(padj) %>% format(digits = 1, scientific = TRUE),
      ", FC = ",
    tmp0 %>% pull(log2FoldChange) %>%`^`(2, .) %>% round(0)
    )
    tmp <- plotCounts(l_de0[[i]], gene = gene, intgroup = "group", returnData = TRUE) %>%
      filter(rownames(.) %in% rownames(blocks[[i]])) 
    lapply(0:1, function(x) filter(tmp, group == x) %>% select(-group)) %>%
    list_cbind0() %>%
    set_colnames(name) %>% 
      set_rownames(rownames(.) %>% str_remove_all("A\\.")) %>%
      plot_violin(title = gene, colour = colour, width_text = 1, stats = FALSE, pch_size = 2, pch_alpha = 0.5, pch_colour = "grey30", label = TRUE, subtitle = subtitle, ..., width_label = 4) +
    # mutate(group = factor(group, labels = c(name[1], name[2]))) %>%
    # ggplot(aes(x = group, y = count, color = group)) +
    # geom_point(position = position_jitter(w = 0.1, h = 0), size = cex * 3, alpha = 0.5) +
    # geom_text_repel(aes(label = colnames(l_de0[[i]]), x = group, y = count, color = group), size = cex * 3) +
    scale_y_log10() # +
    # theme_bw() +
    # labs(
    #     y = "Count",
    #     x = gene
    # ) +
    # scale_color_manual(values = get_colors()[c(2, 4)], name = gene) +
    # theme(
    #     legend.position = "none",
    #     axis.text = element_text(colour = "gray50", size = cex * 10),
    #     axis.title = element_text(colour = "gray50", size = cex * 12, face = "bold.italic"),
    #     axis.ticks = element_blank(),
    #     panel.grid.major.x = element_blank(),
    #     panel.border = element_blank()
    # )
}
lapply(c("CXCL10", "TNFAIP6", "SOCS3", "BATF", "PIM1", "BIRC5", "AURKA", "MTHFD2", "SERPING1", "CFB", "CLU", "MMP2"), function(x) plot_count(i, x, index = "iqr", probalities = c(0.4, 0.85), weight = 1))  %>%
    plot_grid(plotlist = ., nrow = 3, ncol = 3)
  

list.map(top_genes[[i]], f(x) ~ plot_count(i, gene = x) + ylab("")) %>% plot_grid(
    plotlist = .,
    nrow = 2,
    ncol = 2,
    align = "hv"
)
# use_data(l_de_manif, overwrite = TRUE)

outs <- rownames(blocks[[i]]) %>% paste0("^", ., "$", collapse = "|")
name <- str_split(names(blocks)[i], " vs ")[[1]]
attributes(clinic_intersect)$code %>% filter(str_detect(column_code, paste0("^", c("C_2643_3796", "C_2643_3803", "C_2649_3888", "C_2649_3895", "C_2649_3891", "C_2643_3797"), "$", collapse = "|"))) %>% pull(item_name) %>% c("batch") %>% select(clinic_intersect, .) %>% mutate(clinical_center = str_remove_all(clinical_center, "\\d{2} - ") %>% str_remove_all(" \\(.+\\)") %>% str_remove_all(".+ [-â€“] ")) %>% filter(str_detect(immun_aid_identifier, outs)) %>% mutate(Group = ifelse(blocks[[i]] == 0, name[1], name[2])) %>% select(2, 8, 3:4, 7, 6, 1) %>% set_colnames(colnames(.) %>% str_replace_all("_", " ") %>% str_to_sentence()) %>% arrange(Group) %>% kable0()

list.map(list("IL10", "BCL6", "VEGFA"), f(x) ~ plotCounts(l_de0[[i]], gene = x, intgroup = "group", returnData = TRUE) %>% select(-group) %>% set_colnames(x)) %>% Reduce(cbind, .)
```

# Significant genes
```{r}
de_genes0 <- list.map(l_de2, f(i) ~ get_top0(i, fc_threshold, p_threshold, n = 2000) %>%
    rownames() %>%
    str_remove_all("_\\d") %>%
    unique())
unlist(de_genes0) %>% unique() %>% sort() %>% data.frame(id = .) %>% write_tsv("temp.tsv", col_names = FALSE)
cbind(sapply(blocks, function(i) paste0(which(pull(i, 1) == 0) %>% length(), "/", which(pull(i, 1) == 1) %>% length())) %>% as.data.frame() %>% set_colnames(c("N. patients")), sapply(de_genes0, length) %>% as.data.frame() %>% set_colnames(c("N. significant genes"))) %>% kable0()

# fc_cut <- c(1.5, 1.5)
fc_cut <- c(0.5, 1.5)
de_genes1 <- list.map(l_de2, f(i) ~ {
    list.map(c("Up-regulated", "Down-regulated"), f(j) ~ {
      filter(i, Expression == j) %>%
        get_top0(fc_threshold, p_threshold, 2000) %>%
            rownames() %>%
            str_remove_all("_\\d") %>%
            unique()
    })
})

# sapply(de_genes, function(x) paste(sapply(x, length), sep = "/"))

cbind(sapply(blocks, function(i) paste0(which(pull(i, 1) == 0) %>% length(), "/", which(pull(i, 1) == 1) %>% length())) %>% as.data.frame() %>% set_colnames(c("N. patients")), sapply(de_genes1, function(x) paste(sapply(x, length), collapse = "/")) %>% as.data.frame() %>% set_colnames(c("N. significant genes (Up-/Down-regulated)"))) %>%
    kable0() %>%
    kable_styling(bootstrap_options = c("striped", "condensed"))
# %>% slice(c(seq(2), 4))

# de_genes_ranked <- list.map(l_de, f(i) ~ {filter(i, !is.na(padj)) %>% filter(log2FoldChange >= 0.5 | log2FoldChange <= -0.5) %>% filter(pvalue <= 0.2) %>% filter(!str_detect(rownames(.), "Unknown")) -> tmp; tmp$log2FoldChange %>%
#     set_names(rownames(tmp) %>% str_remove_all("_\\d*")) %>%
#     sort(decreasing = TRUE)})


de_genes2 <- list.map(l_de2, f(i) ~ {
    list.map(c("Up-regulated", "Down-regulated"), f(j) ~ {
      filter(i, Expression == j) %>%
        get_top0(2, 0.05, 200) %>%
            pull(ensembl_ids)
    })
})

de_genes_ranked <- list.map(l_de2, f(i, j) ~ {
    get_top0(i, 0.01, 1, n = 50000, rank = TRUE) -> tmp
    (tmp$log2FoldChange) %>%
        set_names(tmp$ensembl_ids) %>%
        sort(decreasing = TRUE)
})
sapply(de_genes_ranked, length)
# top_genes <- list.map(c("Up", "Down"), f(i, j) ~ list.map(de_genes1, .[[j]]))
# list.map(de_genes2, .[[1]])
# plot_venn1(top_genes[[1]], ratio = .4, wrap = 20)
# top_genes0 <- list.map(c("Up", "Down"), f(i, j, k) ~ top_genes[[j]] %>% set_names(paste0(names(.), " (", i, ")")))

top15_genes <-  get_top0(l_de2[[1]], n = 15, fc_threshold = fc_threshold, p = p_threshold) %>% rownames() %>% sort()
sapply(top15_genes, function(i) get_ncbi_gene(i)) %>% unname()

get_genes_path(enriched[[1]][[1]][-3], top15_genes, detect = "Genes", name = "Term", cutoff = 1)
```

```{r, eval = FALSE}
get_intersection(top_genes[[2]])
get_intersection(top_genes[[2]], 2)
get_intersection(top_genes[[2]], 3)
# plot_venn1(de_genes3, ratio = .4, wrap = 20)
filtered <- names(top_genes[[1]]) %>% str_detect("Naive") %>% which()
```

# Network
```{r, eval = FALSE}
t_genes <- list.map(
    unlist(de_genes1[[1]]), 
    f(x) ~ {
        plotCounts(
            l_de0[[1]], 
            gene = x, 
            intgroup = "group", 
            returnData = TRUE
        )  %>% 
            dplyr::select(-group) %>% 
            set_colnames(x)
    }
) %>% Reduce(cbind, .)
t_genes <- t_genes[rownames(t_genes) %in% paste0("A.", c(naive, control)), ]
cutoff <- 0.7
res <- GimmeMyPlot:::mcor_test(
    t_genes,
    estimate = TRUE,
    p.value = TRUE,
    method = "spearman",
    method_adjust = "BH"
)
  r <- res$estimate
  r[abs(r) < cutoff] <- diag(r) <- 0
  r[is.na(r)] <- 0
  p <- res$p.value
  r[p >= 0.05] <- 0
edge <- Edge(r, p)
# as.matrix(edge)  %>% as.data.frame() %>% filter(from %in% n_genes) %>% filter(to %in% n_genes) -> edge
as.matrix(edge)  %>% as.data.frame() %>% filter((from %in% n_genes) | (to %in% n_genes)) -> edge
class(edge) <- c("Edge", class(edge))
node <- Node(edge, scale = FALSE)
edge$label <- as.numeric(edge$label)
edge$weight <- as.numeric(edge$weight)
cex <- 1
# colour_edge = c("#C6C6C6", "#C6C6C6")
colour_edge <- get_colors()[c(3, 1)]
colour_node = c("white", "black")
  edge$color <- ifelse(
    edge$weight > 0,
    colour_edge[1],
    colour_edge[2]
  )
  
  plot_network_dyn(
    dashed = FALSE,
    node = node,
    edge = edge,
    cex = cex,
    cex_edge = edge$weight * 20 * cex,
    color = c(colour_node[1], colour_node[2]),
    mass = 2
) %>% visOptions(manipulation = TRUE) %>%
    visInteraction(navigationButtons = TRUE)
as.matrix(n) %>% as.data.frame() %>% arrange(desc(size)) %>% head(20)
plot_cor_network(m = m)

n_genes <- as.matrix(node) %>% as.data.frame() %>% filter(as.numeric(size) >= 50) %>% pull(id)
# n_genes <- as.matrix(node) %>% as.data.frame() %>% arrange(desc(size)) %>% head(7) %>% pull(id)
as.matrix(node) %>% as.data.frame() %>% column_to_rownames("id") %>% mutate(size = as.numeric(size))  %>% plot_bar(colour = c("#99000D", "gray"), n_max = 15, label_x = "value")
as.matrix(node) %>% as.data.frame() %>% pull(size) %>% as.numeric() %>% plot_violin(pch_size = 2, pch_colour = "grey30", pch_alpha = 0.25)
counts_matrix %>% filter(rownames(.) %in% n_genes) %>% pull(ensembl_gene_id)
get_genes_path(enriched[[1]][[1]][-3], n_genes, detect = "Genes", name = "Term", cutoff = 1)
```

```

# ORA
```{r}
enriched <- list.map(
  c("Up-regulated", "Down-regulated"),
  f(x) ~ {
  list.map(
    compact(de_genes1), 
    f(j) ~ {
    res <- j[[x]]
    if (length(res) > 0) {
        unlist(res) %>%
            head(250) %>%
            enrichr(dbs)
    }
  })
}) %>% compact()

# enriched <- list.map(de_genes, f(i) ~ enrichr(i, dbs))
list.map(
  enriched, 
  f(a, b, c) ~ {
    list.map(
      compact(a),
      f(x, y, z) ~ {
    #   tiff(
    #     file.path(path_img, paste0("enrichr_", z, "_", c, ".tiff")),
    #     units = "px",
    #     width = 8000,
    #     height = 4000,
    #     res = 300
    # )
    keep(x, function(i) nrow(i) > 0) %>%
      list.map(
        f(i, j, k) ~ {
          plot_enrich(
            i,
            n = 15,
            title = str_replace_all(k, "_", " "),
            wrap = 35
            )
          }
        ) %>%
        plot_grid(
            plotlist = .,
            nrow = 2,
            ncol = 3,
            align = "hv"
        ) %>%
          plot_grid(
            ggdraw() + draw_label(
              paste0(z, " (", c,")"),
              color = "#2F5496",
              size = 50,
              fontface = "bold.italic"
              ),
            .,
            ncol = 1,
            rel_heights = c(0.1, 1)
          )
    # dev.off()
  })
}) -> p

# for (i in names(p)) {
#   for (j in names(p[[i]])) {
    # i <- names(p)[1]
    # j <- names(p[[1]])[1]
    # png(
    #     file.path(path_img, paste0("enrichr_", j, "_", i, ".tiff")),
    #     units = "px",
    #     width = 8000,
    #     height = 4000,
    #     res = 300
    # )
    # p[[i]][[j]]
    # dev.off()
    # save_tiff(p[[i]][[j]], file.path(path_img, paste0("enrichr_", j, "_", i, ".tiff")), 8000, 4000)
#   }
# }

# l_enrich <- list.map(de_genes, f(x) ~ enrichr(x, dbs))
# p <- list.map(l_enrich, f(i, j, k) ~ plot_enrich(i[[5]], n = 15, title = str_replace_all(k, "\\.", "-")))
# plot_grid(
#     plotlist = p[c(1, 4)],
#     nrow = 1,
#     ncol = 2,
#     align = "hv"
# )
```

```{r, eval = FALSE} 
list.map(enriched[[1]][[1]], f(j) ~ filter(j, Adjusted.P.value <= 0.05) %>% select(c(1, 4, 9))) %>>% list.filter(.i != 3) %>% keep(function(x) nrow(x) > 0)

list.map(enriched[[1]][[1]], f(j) ~ filter(j, Adjusted.P.value <= 0.05) %>% pull(Term)) %>>% list.filter(.i != 3) %>% compact() %>% unlist() %>% unname() %>% as.data.frame() %>% write_tsv(file = file.path(cwd, "path.tsv"), col_names = FALSE)

list.map(enriched, f(i) ~ list.map(i, f(j) ~ filter(j, Adjusted.P.value <= 0.05) %>%
    dplyr::select(c(1, 4, 9)) %>%
    head(15)) %>% keep(function(x) nrow(x) > 0)) %>% compact() -> tmp0
list.map(enriched0, f(i) ~ list.map(i, f(j) ~ filter(j, Adjusted.P.value <= 0.05) %>%
    dplyr::select(c(1, 4, 9)) %>%
    head(15)) %>% keep(function(x) nrow(x) > 0)) %>% compact() -> tmp1

list.map(dbs, f(j) ~ list.filter(tmp0, f(i) ~ !is.null(i[[j]])) %>% list.names())
# list.map(c(1, 3), f(i) ~ tmp[[2]][[i]] %>% plot_enrich(n = 15, cex = 0.85, title = str_replace_all(dbs[i], "_", " ")))

de_genes1$`aIL1 Non-responder vs aIL1 Responder`[[1]] %>% get_genes_path(enriched[[1]][[3]][-3], ., detect = "Genes", name = "Term", cutoff = 1)

# Compare GSEA with GO
# ck2 <- list.map(de_genes1, f(i, j, k) ~ pluck(i, 2) %>% data.frame(Entrez = ., group = k)) %>%
#     list.rbind() %>% 
#   compareCluster(
#     data = ., 
#     geneClusters = Entrez ~ group,
#     fun = enrichGO, 
#     OrgDb = get(organism),
#     keyType = "SYMBOL", 
#     ont = "ALL"
#     )
# plot_enrich_gsea(ck0)
# cnetplot0(ck0, cex = 1.5, n = 15)
```

```{r}
dgea <- enriched[[1]][[1]]
# dgeas <- list(enriched[[1]][[1]],  c(enriched[[1]][[3]], enriched[[2]][[3]]), enriched[[2]][[4]],  enriched[[2]][[5]])
dgeas <- list(enriched[[1]][[1]], enriched[[2]][[4]],  enriched[[2]][[5]])
paths <- list.map(dgea, f(j) ~ filter(j, Adjusted.P.value <= 0.05) %>% pull(Term)) %>>% list.filter(.i != 3) %>% compact() %>% unlist() %>% unname() %>% sort() %>% str_remove_all("(\\(.*)|((ORPHA)|(WP)|(HSA)|(R-)).*") %>% str_trim() %>% to_title() %>% as.data.frame()

write_tsv(paths, file = file.path(cwd, "path.tsv"), col_names  = FALSE)
# name_immu0 <- c(name_immu, "cytokine" , "platelet")
name_immu1 <- c("neutrophil", "natural killer cell", "macrophage", "leukocyte", " B cell", "T cell")
# name_immu1 <- c("(complement)|(C2 )", "(immune)|(inflammatory)", "mhc", "STAT[ 35]", "(tumor necrosis factor)|(TNF)(NF-k)", "phago((cytosis)|(some))", "(Toll-like)|(TLR )", "WNT")
name_immu1 <- c("(interferon)|(IFN[ABG])", "(interleukins?)|(IL-?\\d)")
name_immu <- c("(complement)|(C2 )", "neutrophil", "(immun)|(inflammatory)", "(interleukins?)|(IL-?\\d)", "(interferon)|(IFN[ABG])", "mhc", "natural killer cell", "STAT[ 35]", "macrophage", "(tumor necrosis factor)|(TNF)(NF-k)", "phago((cytosis)|(some))", "(Toll-like)|(TLR )", "WNT", "leukocyte", " [BT] cell")
top_genes0 <- name_immu %>% lapply(function(x) get_genes_path0(dgea[-3], x) %>% suppressMessages() %>% unlist() %>% unname() %>% unique() %>% sort()) %>% set_names(name_immu) %>% compact()

top_genes1 <- lapply(
  dgeas,
  function(i) {
    name_immu %>% lapply(function(x) get_genes_path0(i[-3], x) %>% suppressMessages() %>% unlist() %>% unname() %>% unique() %>% sort()) %>% set_names(name_immu) %>% compact() %>% unlist() %>% unname() %>% unique() %>% sort()
  # name_immu %>% lapply(function(x) get_genes_path0(i[-3], x) %>% suppressMessages()) %>% compact() %>% list.map(f(x) ~list.map(x, f(y) ~list.map(y, f(z) ~names(z) %>% sort() %>% str_remove_all("(\\(.*)|((ORPHA)|(WP)|(HSA)|(R-)).*") %>% str_trim() %>% to_title())) %>% unlist() %>% unique() %>% sort()) 
    # list.map(i, f(j) ~ filter(j, Adjusted.P.value <= 0.05) %>% pull(Term)) %>>% list.filter(.i != 3) %>% compact() %>% unlist() %>% unname() %>% sort() %>% str_remove_all("(\\(.*)|((ORPHA)|(WP)|(HSA)|(R-)).*") %>% str_trim() %>% to_title() %>% as.data.frame()
  }
) %>% set_names(names(l_de)[c(1, 4:5)])

top_genes1[[4]] <- unlist(de_genes1[[2]]) %>% unname()
top_genes1[[5]] <- unlist(de_genes1[[3]]) %>% unname()
names(top_genes1) <- names(l_de)[c(1, 4:5, 2:3)]
```


```{r, eval = FALSE}
lapply(paths0, function(x) str_replace_all(x, "(.*[Cc]omplement.*)", "Complement activation")) %>% set_names(names(l_de)[c(1, 4:5)])

paste0("((interleukins?)|(IL))-?", seq(12), "[ -/]") %>% lapply(function(x) get_genes_path0(i[-3], x) %>% suppressMessages() %>% unlist() %>% unname() %>% unique() %>% sort()) %>% compact() %>%  set_names(paste0("IL-", c(1, 2, 5, 6, 8, 10, 12))) %>% plot_venn1(n = 8, label = TRUE) +    theme(legend.position = "none")

unlist(top_genes0) %>% unname() %>% fct_count() %>% arrange(desc(n)) %>% filter(n > 1) %>% set_names(c("Genes", "Occurences")) %>% kable0()
plot_venn1(top_genes0, n = 8, label = FALSE) + theme(legend.position = "none")
list.match(top_genes0, "(complement)|(interferon)|(interleukins)|(cytokine)") %>% set_names(c("Complement", "Interferons", "Interleukins", "Cytokine")) %>% plot_venn1(n = 8, label = FALSE) + theme(legend.position = "none")

top_genes <- unlist(top_genes0) %>% unname() %>% unique() %>% sort()

lapply(de_genes1, function(x) unlist(x) %>% unname() %>% sort()) %>% plot_venn1(n = 8, label = FALSE) +    theme(legend.position = "none")
lapply(top_genes, function(x) rownames(x) %>% sort()) %>% plot_venn1(n = 8, label = FALSE) +
    theme(legend.position = "none")

get_genes_path0(enriched[[1]][[1]][-3], "neutrophil") %>% suppressMessages() %>% pluck(1) -> cou
c(cou[[1]], cou[[2]]) %>% set_names(names(.) %>% str_remove_all("(\\(.*)|((ORPHA)|(WP)|(HSA)|(R-)).*") %>% to_title() %>% str_trunc2(n = 40) %>% snakecase::to_any_case(case = "none", sep_in = NULL, unique_sep = "_")) %>% plot_venn1(n = 8, cex_main = 6, cex = 1.5, ratio = 0.2) +
    theme(legend.position = "none")
c(cou[[1]], cou[[2]], cou[[3]], cou[[4]], cou[[5]]) %>% unlist() %>% unname() %>% fct_count() %>% arrange(desc(n)) %>% filter(n > 1) %>% set_names(c("Genes", "Occurences")) %>% kable0()


```

```{r, eval = FALSE}
down <- c("cytokine receptor activity", "IL-2/STAT5 Signaling", "KRAS Signaling Up", "Inflammatory Response", "Interleukin-10 Signaling")
c("TNF-alpha Signaling via NF-kB", "IL-6/JAK/STAT3 Signaling", "MHC class II protein binding", "negative regulation of toll-like receptor signaling pathway", "inflammatory response", 
  "regulation of T cell differentiation", "negative regulation of T cell differentiation", "regulation of T-helper 1 cell cytokine production",
  "positive regulation of receptor signaling pathway via STAT", "positive regulation of receptor signaling pathway via JAK-STAT", "positive regulation of T-helper 1 cell cytokine production",
  "regulation of MAPK cascade", "positive regulation of MAPK cascade", "regulation of MAP kinase activity", "MAPK cascade")

up <- c("Interferon Gamma Response", "Inflammatory Response", "Interferon Alpha Response", "Complement")
c("TNF-alpha Signaling via NF-kB", "Complement Activation", "regulation of chemokine-mediated signaling pathway", "negative regulation of leukocyte migration")

(up_genes <- get_genes_path(enriched[[1]][[1]], up) %>% suppressMessages())
(down_genes <- get_genes_path(enriched[[2]][[1]], down) %>% suppressMessages())

up_genes %>% unlist() %>% sort() %>% unique() %>% get_genes_path(enriched[[1]][[1]][c(seq(2), 4:6)],. , detect = "Genes", name = "Term")
# list.search(cou, str_subset(., "Interferon"))

# list.map(c("Complement", "Interferon"), f(x) ~list.search(cou, str_subset(., x)) %>% names())

# list.map(vars, get_genes_path(c(enriched[[1]][[1]][c(seq(2), 4:6)], enriched[[2]][[1]][c(seq(2), 4:6)]),. , detect = "Genes", name = "Term"))

# ctr %>% head(10) %>% rownames() %>% get_genes_path(c(enriched[[1]][[1]][c(seq(2), 4:6)], enriched[[2]][[1]][c(seq(2), 4:6)]), . , detect = "Genes", name = "Term")

top_genes1 <- c(up_genes, down_genes) %>% unlist() %>% sort() %>% unique() %>% list() %>% set_names(names(blocks))
```


```{r, eval = FALSE}
immu_genes <- c("WARS1", "BATF2", "FCGR1A", "LAP3", "GBP2", "C2")
# immu_genes <- c("CCL4", "TNF", "CXCL2", "IL1B")
# ADM, IRF1, PELI1, ABCA1
immu_genes %in% unlist(up_genes)
lapply(immu_genes, function(x) list.search(up_genes, .[. == x]) %>% names())

(diff_paths <- get_genes_path(enriched[[1]][[1]], query = immu_genes, name = "Term", detect = "Genes") %>% suppressMessages())

top_genes0 <- list.map(l_de2, f(i) ~ get_top0(i, n = 50) %>%
    rownames() %>%
    str_remove_all("_\\d") %>%
    unique())
```

```{r, eval = FALSE}
enriched0 <- enriched[[1]][[1]][c(seq(2), 4:6)]
enrich_genes0 <- c(
    get_genes_path(enriched0, "complement") %>% format_path() %>% .[seq(3)],
    get_genes_path(enriched0, "inflam") %>% format_path(),
    get_genes_path(enriched0, "stat") %>% format_path(),
    get_genes_path(enriched0, "interferon") %>% format_path()
)

top_genes0 <- enrich_genes0 %>% unlist() %>% unname() %>% unique() %>% sort() %>% list() %>% set_names(names(enriched[[1]]))

top_genes1 <- list.map(l_de2, f(i) ~ get_top0(i, n = 50) %>%
    rownames() %>%
    str_remove_all("_\\d") %>%
    unique())
```

# Heatmap
```{r}
blocks1 <- blocks -> blocks11
# blocks2 <- list.map(seq(length(blocks1)), f(i) ~ select(counts_matrix, rownames(blocks[[i]])) %>% filter(rownames(.) %in% head(de_genes0[[i]], 10)))
# blocks2 <- list.map(seq(length(blocks1)), f(i) ~ select(counts_matrix, rownames(blocks[[i]])) %>% filter(rownames(.) %in% sapply(de_genes[[i]], function(x) head(x, 10)) %>% unlist()))
blocks2 <- list.map(
  names(top_genes1), 
  f(i) ~ {
    list.map(
      top_genes1[[i]], 
      f(x) ~ {
        plotCounts(
          l_de0[[i]], 
          gene = x, 
          intgroup = "group", 
          returnData = TRUE
        )  %>% 
        dplyr::select(-group) %>% 
        set_colnames(x)
      }
    ) %>% Reduce(cbind, .) %>% t()
  }
)
j <- 1
i <- names(blocks1)[j]
# colnames(blocks2[[i]]) <- rownames(blocks1[[i]]) <- rownames(blocks1[[i]]) %>% str_remove_all("A\\.")
colnames(blocks2[[i]]) <- rownames(blocks1[[i]]) <- str_replace_all(rownames(blocks1[[i]]), "([AB])\\.(.*)", "\\2\\-\\1") %>% str_remove_all("\\-[AB]")
# names_levels <- c("AOSD", "SOJIA")
names_levels <- str_split(i, " vs ") %>% pluck(1)
# names_levels <- c("Naive", "GC-Corticoid", "GC-Corticoid + aIL1", "aIL1 only")
# disease <- clinic_intersect %>% filter(rownames(.) %in% colnames(blocks2[[i]])) %>% pull(disease) %>% factor(labels = names_levels)
# disease <- ifelse(blocks1[[i]] == 0, names_levels[1], names_levels[2]) %>% set_colnames("Treatment")
disease <- dplyr::select(blocks1[[i]], group) %>% mutate(group = factor(group, labels = names_levels)) %>% set_colnames("Group")
row_annotation <- data.frame(Group = disease)
# row_annotation[1, ] <- "GC-Corticoid + aIL1"
# row_annotation[2, ] <- "aIL1 only"
res_scaled <- blocks <- t(blocks2[[i]])
res_scaled_na <- scale0(blocks, "minmax")
```


```{r, eval = FALSE}

disease <- ifelse(blocks1[[2]] == 0, names_levels[1], names_levels[2]) %>% set_colnames("Treatment")
row_annotation <- data.frame(Treatment = disease)
blocks_ <- t(blocks2[[2]]) %>%
    data.frame() %>%
    mutate(Treatment = disease) %>%
    set_rownames(paste0(ifelse(disease == 0, "A", "B"), rownames(.))) %>%
    mutate(variable = rownames(.))

select(blocks_, -FAM13A) %>% ggplot(data = ., aes(x = 1, y = as.character(variable), fill = as.numeric(Treatment))) +
    geom_tile() +
    scale_x_continuous(breaks = 1, labels = "Treatment") +
    scale_y_discrete(position = "right") +
    scale_fill_gradientn(colors = get_colors()[c(5, 1)], na.value = "black") +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(), axis.ticks = element_blank(), legend.position = "none", axis.title = element_blank(), axis.text.x = element_text(face = "bold", angle = -45, hjust = 0.25, vjust = 0.25)
    ) +
    theme(axis.text = element_text(colour = "black", size = 14))
select(blocks_, -Treatment) %>% ggplot(data = ., aes(x = 1, y = as.character(variable), fill = as.numeric(FAM13A))) +
    geom_tile() +
    scale_x_continuous(breaks = 1, labels = rownames(blocks2[[2]])) +
    scale_y_discrete(position = "right") +
    scale_fill_gradientn(colors = colors_ind, na.value = "black") +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(), axis.ticks = element_blank(), legend.position = "none", axis.title = element_blank(), axis.text.x = element_text(angle = -45, hjust = 0.25, vjust = 0.25)
    ) +
    theme(axis.text = element_text(colour = "black", size = 14))
```

# GSEA
```{r}
# ClusterProfiler
gse <- list.map(
  de_genes_ranked, 
  f(i) ~ {
    gseGO(
      i, 
      ont = "ALL",
      OrgDb = get(organism), 
      keyType = "ENSEMBL"
      ) %>%
      setReadable('org.Hs.eg.db', 'ENSEMBL')
    }) %>%
  purrr::keep(function(x) nrow(as.data.frame(x)) > 0)
# dotplot(gse, showCategory = 10)

# list.map(gse, f(i) ~ data.frame(i)) %>%
keep(gse, function(i) nrow(i) > 0) %>%
    list.map(
      f(i, j, k) ~ {
        clusterProfiler::simplify(i) %>%
          plot_enrich(n = 25, wrap = 50, type = "gsea", title = "")
        }
      ) -> p
    # list(pluck(., 1), pluck(., 2), NULL, pluck(., 3), pluck(., 4)) %>%
plot_grid(
    plotlist = p[-2],
    nrow = 2,
    ncol = 2,
    align = "hv"
)# %>%
# save_tiff(file.path(path_img, "gsea_treat2.tiff"), 8000, 4000)

# Cluster categories
enrichplot::pairwise_termsim(gse[[1]]) %>% emapplot(showCategory = 10)
enrichplot::pairwise_termsim(gse[[1]]) %>% treeplot(showCategory = 50)

cnetplot0(gse, foldChange = de_genes_ranked[["aIL1 Naive vs aIL1 Responder"]])
upsetplot(gse[[1]])

# GSEA quality
gseaplot(gse[[1]], by = "all", title = gse$Description[1], geneSetID = 1)
gseaplot2(gse[[4]], title = gse[[4]]$Description[1], geneSetID = 1)
ridgeplot(gse[[1]], showCategory  = 50) + labs(x = "enrichment distribution")

goplot(gse[[4]])

# Enrichment plot
list.map(
    gse,
    f(i, j, k) ~ {
        plot_enrich_gsea(i, wrap = 70) + 
            labs(title = k)
    }
) %>% plot_grid(
    plotlist = .,
    nrow = 2,
    ncol = 2,
    align = "hv"
)

# Common pathways between models
list.map(
    gse,
    f(j) ~ {
        as.tibble(j) %>%
            pull("Description") %>%
            sort()
    }) %>% unlist() %>% sort() %>% unique()
list.map(gse, {plot_enrich_gsea(., 15) -> p; as.character(p$data$Description)}) %>% unlist() %>% sort() %>% unique() 

# Common genes between pathways
list.map(
    gse[-2],
    f(i, j, k) ~ {
        # setReadable(i, OrgDb = get(organism), keyType = "ENSEMBL") %>%
            heatplot0(i, foldChange = de_genes_ranked[[k]]) + 
            labs(title = k) + theme(legend.position = "none")
    }
)  %>% plot_grid(
    plotlist = .,
    nrow = 3,
    ncol = 1,
    align = "hv"
)

# Common genes between models
get_enrich_genes(gse, "go") %>% plot_venn1(ratio = .3)
get_enrich_genes(gse, "go") %>% get_intersection(n = 1) %>% Filter(function(x) length(x) > 4, .)

# Compare GSEA with GO
ck_go <- lapply(
  de_genes_ranked, 
  function(x) data.frame(Entrez = names(x), logFC = x)
  ) %>% 
  list.rbind() %>%
  mutate(group = sapply(rownames(.), function(x) str_split(x, "\\.")[[1]] %>% .[1])) %>% 
  compareCluster(
    data = ., 
    geneClusters = Entrez | logFC ~ group, 
    fun = gseGO, 
    OrgDb = get(organism),
    keyType = "ENSEMBL", 
    ont = "ALL"
    ) %>% 
  setReadable(OrgDb = get(organism), keyType = "ENSEMBL")
plot_enrich_gsea(ck_go)
cnetplot0(ck_go)
```

# Kegg pathways
```{r, eval = FALSE}
# Convert gene list into KEGG IDs
kegg_genes <- list.map(de_genes_ranked, f(i) ~ {
    bitr(names(i), fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = get(organism)) %>% left_join(data.frame(ENSEMBL = names(i), log2FoldChange = i)) -> tmp
    tmp$log2FoldChange %>%
        set_names(pull(tmp, ENTREZID)) %>%
        sort(decreasing = TRUE)
})
sapply(kegg_genes, length)

# Compare GSEA with KEGG
ck_kegg <- lapply(
  kegg_genes, 
  function(x) data.frame(Entrez = names(x), logFC = x)
  ) %>%
  list.rbind() %>%
  mutate(group = sapply(rownames(.), function(x) str_split(x, "\\.")[[1]] %>% .[1])) %>% 
  compareCluster(
    data = ., 
    geneClusters = Entrez | logFC ~ group, 
    fun = "gseKEGG", 
    organism = "hsa"
    ) %>% 
  setReadable(OrgDb = get(organism), keyType = "ENTREZID")

plot_enrich_gsea(ck_kegg)
cnetplot0(ck_kegg)

# Perform GSEA with KEGG
gsea_kegg <- list.map(
  kegg_genes, 
  f(i) ~ {
    gseKEGG(
    geneList = i,
    organism = "hsa",
    # keyType = "ncbi-geneid"
  ) %>%
      setReadable(OrgDb = get(organism), keyType = "ENTREZID")
  }
) %>% 
  purrr::keep(function(x) nrow(as.data.frame(x)) > 0)

# Enrichment plot
# list.map(gsea_kegg, f(i) ~ data.frame(i)) %>%
    # keep(function(i) nrow(i) > 0) %>%
    list.map(gsea_kegg, f(i, j, k) ~ plot_enrich(i, 15, type = "gsea", title = k)) %>%
    # list.map(gsea_kegg,  f(i, j, k) ~ plot_enrich_gsea(i, 15) + labs(title = k)
plot_grid(
        plotlist = .,
        nrow = 2,
        ncol = 1,
        align = "hv"
    )

# Common genes between pathways
list.map(
    gsea_kegg,
    f(i, j, k) ~ {
        # setReadable(i, OrgDb = get(organism), keyType = "ENTREZID") %>%
        heatplot0(i, foldChange = kegg_genes[[k]]) + 
        labs(title = k) + 
        theme(legend.position = "none")
    }
)  %>% plot_grid(
    plotlist = .,
    nrow = 2,
    ncol = 1,
    align = "hv",
    rel_heights = c(1, 1.5)
)
# get_kegg_path(gsea_kegg, "Human T")

# Common genes between models
get_enrich_genes(gsea_kegg) %>% plot_venn1(cex = 1.5, n = 20)
get_enrich_genes(gsea_kegg) %>% get_intersection0()

# c("CD3D", "CD3E", "CD3G", "CD8A", "LCK") %>% bitr(fromType = "ALIAS", toType = c("ENTREZID"), OrgDb = get(organism)) -> tmp

enrich_kegg <- list.map(
  c("Up-regulated", "Down-regulated"),
  f(x) ~ {
    list.map(
      compact(de_genes1),
      f(i) ~ {
        res <- bitr(i[[x]], fromType = "ALIAS", toType = "ENTREZID", OrgDb = get(organism))
    if (length(res) > 0) {
        pull(res, 2) %>%
            head(250) %>%
            enrichKEGG(organism = "hsa")
    }
    }) %>% compact() %>% purrr::keep(function(x) nrow(as.data.frame(x)) > 0)
}) %>% compact()

list.map(
  enrich_kegg,
  f(i, j, k) ~ {
    list.map(
      i, 
      f(x, y, z) ~ {
    #   tiff(
    #     file.path(path_img, paste0("enrichr_", z, "_", ittt, ".tiff")),
    #     units = "px",
    #     width = 8000,
    #     height = 4000,
    #     res = 300
    # )
    plot_enrich(x, wrap = 35, n = 11, type = "kegg", title = "KEGG") + labs(x = "") # paste0(z, " (", str_to_title(k), ")") %>% str_wrap(20))
        })
    # dev.off()
}) -> p3

# plot_grid(
#     plotlist = c(p[[1]][-2], p[[2]]),
#     nrow = 2,
#     ncol = 3,
#     align = "hv"
# )
plot_grid(
    plotlist = p3[[1]],
    nrow = 2,
    ncol = 3
)
plot_grid(
    plotlist = p3[[2]],
    nrow = 2,
    ncol = 3
)
```

```{r, eval = FALSE}
# Common pathways between models
list.map(enrich_kegg, list.map(., f(j) ~ sort(j$Description))) -> pathways
pathways0 <- c(pathways[[1]][-2], pathways[[2]]) %>% set_names(paste(c(rep("Up", 2), rep("Down", 4)), names(.)))
plot_venn1(pathways0[-c(2:3)]), label = FALSE)
get_intersection(pathways0[-c(2:3)])

get_kegg_path(enrich_kegg, "Human T")

genes <- get_enrich_genes(c(enrich_kegg[[1]], enrich_kegg[[2]]), "Human T")  %>% set_names(sapply(c(1, 2), function(x) paste0(names(enrich_kegg[[x]]), " (", names(enrich_kegg)[x],")")) %>% unlist())

plot_venn1(genes, label = FALSE, colour = get_colors()[c(1, 4, 6, 8, 2:3, 5)])
get_intersection0(genes[-c(2:3)])

as.tibble(enrich_kegg[[2]][[4]]) %>%  filter(str_detect(Description,  "Human T")) %>% pull(geneID) %>% str_split("/") %>% pluck(1) %>% bitr(fromType = "ENTREZID", toType = "ALIAS", OrgDb = get(organism)) %>% pull(2)

pathview(gene.data = kegg_genes[[1]], species="hsa", pathway.id="hsa04060", low = list(gene = "#377EB8", cpd = "blue"), mid = list(gene = "gray", cpd = "gray"), high = list(gene = "#E41A1C", cpd =
"yellow"))
```

```{r}
gse_wiki <- lapply(
  kegg_genes,
  function(x) {
    gseWP(x, organism = "Homo sapiens") %>%
  setReadable(OrgDb = get(organism), keyType = "ENTREZID")
  }
)
plot_enrich(gse_wiki , n = 25, wrap = 50, type = "gsea", title = "WikiPathway")

# gsePathway(kegg_genes[[1]], 
#                 pvalueCutoff = 0.05,
#                 pAdjustMethod = "BH", 
#                 verbose = FALSE)

library(DOSE)
gse_do <- lapply(kegg_genes, function(x) gseDO(x, verbose = FALSE))
gse_dgn <- lapply(kegg_genes, function(x) gseDGN(x, verbose = FALSE))

# library(AnnotationHub)
# library(MeSHDbi)
# ah <- AnnotationHub(localHub = TRUE)
# hsa <- query(ah, c("MeSHDb", "Homo sapiens"))
# file_hsa <- hsa[[1]]
# db_mesh <- MeSHDbi::MeSHDb(file_hsa)
db_mesh <- MeSHDbi::MeSHDb("C:\\Users\\etien\\AppData\\Local/R/cache/R/AnnotationHub/70c065c527f7_98354")
library(meshes)
gse_mesh <- lapply(kegg_genes, function(x) gseMeSH(x, MeSHDb = db_mesh, database = 'gene2pubmed', category = "G"))
```

```{r, eval = FALSE}
library(msigdbr)

db_msig <- msigdbr(species = "Homo sapiens", category = "C7")
msig_gene <- select(db_msig, gs_name, entrez_gene)
msig_description <- select(db_msig, gs_name, gs_description)
gse_msig <- lapply(
  kegg_genes, 
  function(x) {
    GSEA(x, TERM2GENE = msig_gene, TERM2NAME = msig_description) %>%
  setReadable(OrgDb = get(organism), keyType = "ENTREZID")
  }
)

db_msig2 <- msigdbr(species = "Homo sapiens")
msig_gene2 <- select(db_msig2, gs_name, entrez_gene)
msig_description2 <- select(db_msig2, gs_name, gs_description)
gse_msig2 <- lapply(
  kegg_genes, 
  function(x) {
    GSEA(x, TERM2GENE = msig_gene2, TERM2NAME = msig_description2) %>%
  setReadable(OrgDb = get(organism), keyType = "ENTREZID")
  }
)
```

```{r}
gse <- list(gse_go, gsea_kegg, gse_wiki, gse_do, gse_dgn, gse_mesh)
# use_data(gse, overwrite = TRUE)
titles <- c("GO", "KEGG", "WikiPathway", "Disease Ontology", "Disease Gene Network", "MeSH", "MSigDb")
p3 <- lapply(
  names(l_de),
  function (x) {
    print(x)
    lapply(
      seq(gse),
      function(i) {
        print(i)
        if (!is.null(gse[[i]][[x]]) && nrow(gse[[i]][[x]]) > 0) {
          plot_enrich(
            gse[[i]][[x]], 
            n = 15, 
            wrap = 35,
            type = "gsea",
            title = titles[i]
          ) + theme(axis.title.x = element_blank())
        }
      }
    ) %>%
        plot_grid(
            plotlist = .,
            nrow = 2,
            ncol = 3,
            align = "hv"
      ) %>%
        plot_grid(
          ggdraw() + draw_label(
            x,
            color = "#2F5496",
            size = 50,
            fontface = "bold.italic"
            ),
          .,
          ncol = 1,
          rel_heights = c(0.1, 1)
        )
  }
)

plot_grid(
    plotlist = p3[[1]],
    nrow = 2,
    ncol = 3,
    align = "hv"
)

lapply(
  seq(gse), 
  function(x) {
    if (length(gse[[x]]) > 1) {
      lapply(
        list.match(gse[[x]], "(Control)|(aIL1 Naive vs aIL1 Responder)"),
        function(x) {
          str_remove_all(
            x$Description, "\\(.*") %>%
            str_remove_all("((ORPHA)|(WP)|(HSA)|(R-)).*") %>%
            to_title()
        }
      ) %>% plot_venn1(n = 35, label = FALSE) +
          theme(legend.position = "none")  # %>%
      # plot_grid(
      #   ggdraw() + draw_label(
      #     titles[x],
      #     color = "#2F5496",
      #     size = 15,
      #     fontface = "bold.italic"
      #     ),
      #   .,
      #   nrow = 2,
      #   ncol = 1,
      #   rel_heights = c(0.1, 1)
      # )
    }
  }
) %>%
  plot_grid(
    plotlist = .,
    nrow = 2,
    ncol = 3,
    align = "hv"
  )
```

# Cytokines
```{r}
samples <- read_tsv(file.path(path, "cytosig.Zscore"), n_max = 1, col_names = FALSE)
cyt <- read_tsv(file.path(path, "cytosig.Zscore"), skip = 1, col_names = FALSE) %>% set_colnames(c("geneName", str_remove_all(samples, "\\d{2}PB\\d") %>% str_replace_all("0?(.*)([AB])", "\\2.\\1")))

# cyt <- read_tsv(file.path(path, "deconvolution_batch5.tsv")) %>% rename(geneName = cell_type) %>% set_colnames(colnames(.) %>% str_remove_all("\\d{2}PB\\d") %>% str_replace_all("0?(.*)([AB])", "\\2.\\1"))
# cyt[cyt < 0] <- 0

l_cyt <- list.map(blocks, f(x) ~ { rownames(x) %>% c("geneName", .) ->tmp ; select(cyt, contains(tmp))})

cyt <- read_csv(file.path(path, "scores_still.csv")) %>% t() %>% as.data.frame() %>% row_to_names(row_number = 1) %>% set_colnames(colnames(.) %>% as.numeric()) %>% mutate(geneName = rownames(.) %>% str_replace_all("_", " "))
l_cyt <- list.map(blocks11, f(x) ~ {rownames(x) %>% str_remove("A.") %>% c("geneName", .) -> tmp; select(cyt, contains(tmp))}) 

# colour_var <- colorRampPalette(
#   c(brewer.pal(9, "YlOrBr")[4:7],
#     brewer.pal(9, "RdBu")[1:3],
#     brewer.pal(11, "PiYG")[4:1],
#     brewer.pal(11, "PRGn")[1:4],
#     brewer.pal(11, "RdYlBu")[8:11],
#     brewer.pal(11, "BrBG")[10:8],
#     brewer.pal(11, "PiYG")[8:11]
#     )
#   )(nrow(cyt))
# colour_var <- c(
#     brewer.pal(9, "Set1")[c(1:3, 3:5, 8)],
#     rev(brewer.pal(7, "Set2")[c(6:5)]),
#     brewer.pal(8, "Pastel1")[-c(3, 6:7, 9)]
# )

i = 1
list.map(
  c(0, 1),
  # unique(cl0$cl),
  f(j) ~ {
    filter(blocks11[[i]], group == j) %>%
    # filter(cl0, cl == j) %>%
      rownames() %>%
      # pull("immun_aid_identifier") %>%
      # list.map(f(y) ~ filter(l_cyt0[[i]], as.numeric(Patient) == y)) %>% list_rbind()
      # paste0("A.", .) %>%
      c("geneName", .) -> tmp
      select(l_cyt[[i]], contains(tmp)) %>%
      t() %>%
      as.data.frame() %>%
      row_to_names(row_number = 1)
    }
  ) -> tmp
# vars <- c("IL1A", "IL1B", "IL4", "IL4", "IL6", "IL12", "IFN1", "IFNG", "IFNL")
vars <- c("Monocyte conventional", "Neutrophil", rep("NK cell", 2), "T cell CD4+ naive", "T cell CD8+ naive", "T cell CD4+ memory", "T cell CD8+ memory")
# vars <- c(vars[1:3], vars[3:7])
list.map(
  # pull(cyt, "geneName") %>% sort(),
  vars,
  f(j, jj) ~ {
    list.map(tmp, f(k) ~ select(k, j)) %>% 
      list_cbind() %>% 
      set_colnames(rep("", 2)) %>% 
      as.data.frame() %>% 
      update_columns(1:2, as.numeric) %>% 
      plot_violin0(
        method = "wilcox",
        # colour = get_colors()[seq(length(unique(cl)))],
        colour = get_colors()[c(5, 3)],
        # colour = brewer.pal(12, "Paired")[4:3],
        color_title = "black",
        wrap = 5,
        size = 3,
        pch_colour = "gray50",
        wrap_title = 15,
        pch_alpha = 0.5,
        ylab = "",
        title = j
      ) + theme(
        axis.title = element_blank()
      )
    }
  ) %>% 
 plot_grid(
        plotlist = .,
       align = "hv",
        nrow = 3, # 6,
        ncol = 3 # 8
    )


t_cyt <- l_cyt[[i]] %>% 
    t() %>%
    as.data.frame() %>% 
    row_to_names(row_number = 1) 

stats <- t_cyt %>%
  rownames_to_column("immun_aid_identifier") %>%
  right_join(mutate(cl0, immun_aid_identifier = paste0("A.", immun_aid_identifier))) %>%
  column_to_rownames("immun_aid_identifier") %>%
  mutate(cl = pull(blocks11[[i]], group)) %>%
  update_columns(seq(nrow(l_cyt[[i]])), as.numeric) %>%
  calculate_test1(method = "wilcox", stats = TRUE)

filter(stats, p <= 0.1) %>%
  select(-c("W", "FDR", "  ")) %>%
  kable0()

```

