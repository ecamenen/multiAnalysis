---
title: "SOM"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SOM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

# Setup
```{r setup}
library(multiAnalysis)
set.seed(123)
set_analysis(block_name = "clinic_tot_raw")
set_analysis(block_name = "clinic_still_processed", to_remove = c("1007", "1014"))
hc_metric <- "pearson"
blocks <- blocks[[1]]
n_run <- 100000
MAX_CLUSTERS <- 6
hc_method <- 3
k <- 4
colors_k <- brewer.pal(n = 9, name = "Set1")[seq(k) + 2]
cols <- function(a = 1) {
      c(rgb(77 / 250, 175 / 250, 75 / 250, a), rgb(150 / 250, 80 / 250, 150 / 250, a), rgb(1, 40 / 250, 45 / 250, a), rgb(1, 0.5, 0, a), rgb(0 / 250, 120 / 250, 180 / 250, a))
  }
# c(rgb(77/250, 175/250, 75/250, a),rgb(77/250, 175/250, 75/250, a),rgb(150/250, 80/250, 150/250, a), rgb(150/250, 80/250, 150/250, a)) #, rgb(1, 40/250, 45/250, a), rgb(1, 0.5, 0, a), rgb(0/250, 120/250, 180/250, a))

col_grp <- function(x = som_clusters, a = 1) {
    x <- as.factor(x)
    levels(x) <- cols(a)
    return(as.vector(x))
}
```

# Data preparation
```{r}
res_scaled_na <- scale0(blocks, "zscore")
res_scaled <- res_scaled_na
res_scaled[is.na(res_scaled)] <- 0
```

# Modelling
```{r}
som_grid <- somgrid(
    xdim = 4,
    ydim = 4,
    topo = "hexagonal",
    toroidal = TRUE
)
# som_model <- som(as.matrix(res_scaled), grid = som_grid, rlen = n_run)

path <- file.path(golem::get_golem_wd())
file_path <- file.path(path, "data", "som_model_all.RData")
# save(som_model, file = file_path)
load(file_path)

plot(som_model, type = "changes")

som_inds <- som_model$unit.classif %>% set_names(rownames(blocks))
print(sapply(seq(max(som_inds)), function(x) names(som_inds[som_inds == x])))
som_inds %>%
    as.factor() %>%
    fct_infreq() %>%
    fct_count()
```

# Clustering
```{r}
# Data preparation
som_codes <- som_model$codes[[1]]
rownames(som_codes) <- rownames(som_codes) %>% gsub("V", "N", .)

# Clustering for the samples
res_dist <- get_dist(som_codes, stand = FALSE, method = hc_metric)
n <- nrow(som_codes) - 2
if (MAX_CLUSTERS > n) {
    MAX_CLUSTERS <- n
}
classif <- getClassif(hc_method, MAX_CLUSTERS, som_codes, res_dist)
cls <- getClusterPerPart(MAX_CLUSTERS, classif)
cl_summary <- get_summary(res_dist, cls, MAX_CLUSTERS, k = 2)
cl_summary
k <- which.max(cl_summary$`Silhouette index`) + 1
lapply(
    2:MAX_CLUSTERS,
    function(i) plot_silhouette0(res_dist, cls, i)
) %>%
    plot_grid(
        plotlist = .,
        align = "vh",
        labels = paste("k =", 2:MAX_CLUSTERS),
        hjust = 0,
        nrow = 2,
        ncol = 3
    )

# Variable contribution
100 * getCtrVar(k, cls[[k - 1]], som_codes)
ctr <- getDiscriminantVariables(k, cls[[k - 1]], som_codes, ncol(som_codes))
plotHistogram(df = ctr)


# res0 <- pvclust(
#   t(som_codes),
#   method.hclust = hc_method,
#   method.dist = "euclidian",
#   use.cor = "pairwise.complete.obs",
#   nboot = n_boot,
#   parallel = TRUE
# ) %>% suppressWarnings()
# plot_dendrogram(res0, k = k, color = colors_k)
som_clusters <- cls[[k - 1]]
# som_clusters <- read.csv2(file.path(path, "clusters0.temp.tsv"))$cl0
ind_clusters <- som_clusters[som_inds]
ind_clusters %>%
    as.factor() %>%
    fct_infreq() %>%
    fct_count()

# Disease per groups
names(ind_clusters) <- disease
lapply(seq(k), function(i) {
    ind_clusters[ind_clusters == i] %>%
        names() %>%
        fct_infreq() %>%
        fct_count() %>%
        filter(n > 2) %>%
        data.frame(., i) %>%
        # set_colnames(rep("", 2))
        set_colnames(c("Disease", "N/cluster", "Cluster"))
}) %>%
    # set_names(paste("Cluster", seq(k)))
    list.stack()

# names(ind_clusters) <- rownames(res_scaled_na)
lapply(seq(k), function(i) ind_clusters[ind_clusters == i])

# Quality per samples
ind_dist <- get_dist(res_scaled, stand = FALSE, method = hc_metric)
ind_cls <- list.map(cls, f(i) ~ i[som_inds])
ind_summary <- get_summary(ind_dist, ind_cls, MAX_CLUSTERS, k = 2)
ind_summary
lapply(
    2:MAX_CLUSTERS,
    function(i) plot_silhouette0(ind_dist, ind_cls, i)
) %>%
    plot_grid(
        plotlist = .,
        align = "vh",
        labels = paste("k =", 2:MAX_CLUSTERS),
        hjust = 0,
        nrow = 2,
        ncol = 3
    )

```

# Code plots
```{r}
par(mfrow = c(2, 2))
plot(som_model, type = "counts", shape = "straight", border = NA)
dist_neighbours <- plot(som_model, type = "dist.neighbours", shape = "straight", border = NA)
print_stats(dist_neighbours)
add.cluster.boundaries(som_model, som_clusters, lwd = 5, col = "white")
quality <- plot(som_model, type = "quality", shape = "straight", border = NA)
print_stats(quality)
plot(
    som_model,
    cex = 0.7,
    type = "mapping",
    labels = names(ind_clusters),
    col = col_grp(x = ind_clusters),
    bg = col_grp(a = 0.25),
    shape = "straight",
    border = NA
)
add.cluster.boundaries(som_model, som_clusters, lwd = 5, col = "white")
par(mfrow = c(1, 1))

# plot(som_model, type = "codes", palette.name = rainbow, codeRendering = "segments")

# write.csv2(as.data.frame(ind_clusters), "clusters_som2.temp.tsv")
```
