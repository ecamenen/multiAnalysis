---
title: "QC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(multiAnalysis)
set.seed(1)

plot_dimred <- function(coord, axis, eig = NULL, geom = "point", axis_text = FALSE, legend = "Batch") {
  coord <- as.data.frame(coord) %>% set_colnames(c("x", "y", "var"))
  if (!is.null(eig)) {
      axis <- paste0(axis, " (", paste(round(eig[seq(2)], 1), "%)"))
  }
  p <- ggplot(coord, aes(x = x, y = y, color = var)) +
    geom_hline(yintercept = 0, size = .5, color = "gray70") +
    geom_vline(xintercept = 0, size = .5, color = "gray70") +
    labs(x = axis[1], y = axis[2], color = legend) +
    theme_minimal() +
    theme(
        axis.title = element_text(size = 15, face = "bold.italic", color = "gray50"),
        legend.title = element_text(size = 15, face = "bold.italic", color = "gray50"),
        legend.text = element_text(size = 13, color = "gray50")
    )
  if (pull(coord, "var") %>% is.numeric()) {
    p <- p + scale_color_gradientn(colors = colors_ind)
  } else {
    p <- p + 
      scale_color_manual(
        values = brewer.pal(n = length(levels(pull(coord, "var"))), name = "Set1"), 
        na.value = brewer.pal(n = 8, name = "Set2")[6]
      ) +
      guides(color = guide_legend(override.aes = list(shape = 15, size = 4)))
  }
    
  if (axis_text) {
    p <- p + theme(axis.text = element_text(size = 13, color = "gray50"))
  } else {
    p <- p + theme(axis.text = element_blank())
  }
  if (geom == "point") {
    p + geom_point(alpha = 0.5)
  } else {
    p + geom_text_repel(aes(label = rownames(coord)), force = 0.2, max.iter = 500)
  }
}

trans_coord <- function(coord) {
  as.data.frame(coord) %>% 
  set_colnames(axis) %>%
  mutate(batch = batch)
}
```

```{r}
path <- golem::get_golem_wd()
cwd <- file.path(path, "inst", "extdata")
raw_counts <- read_tsv(file.path(cwd, "gene_counts.tsv")) %>% column_to_rownames("gene_id")
batch <- read_tsv(file.path(cwd, "batch_rna.tsv")) %>% mutate(batch = as.factor(batch))
batch <- data.frame(Sample = colnames(raw_counts)) %>% full_join(batch, by = "Sample") %>% column_to_rownames("Sample") %>% pull(batch)
clinic <- read_tsv(file.path(cwd, "clinic.tsv")) %>% 
  select(c("C_2643_3796", "C_2649_3888", "C_2649_3895", "C_2643_3803", "C_2649_3890")) %>%
  set_colnames(c("Sample", "Gender", "Ethnicity", "Age", "BMI"))
```

```{r data}
combat_counts <- as.matrix(raw_counts) %>%
    ComBat_seq(batch) %>%
    as.data.frame()
norm_rna0 <- round(raw_counts) %>% as.matrix() %>% vst()
colnames(norm_rna0) <- colnames(norm_rna0) %>% str_remove_all("05PB1")
norm_rna <- round(combat_counts) %>% as.matrix() %>% vst()
colnames(norm_rna) <- colnames(norm_rna) %>% str_remove_all("05PB1")
ncomp <- 2
axis <- paste0("Dim. ", seq(ncomp))
```

```{r umap}
res <- umap(t(norm_rna))
coord <- trans_coord(res$layout)
plot_dimred(coord, axis)
metadata <- rownames_to_column(coord, "ID") %>% 
  mutate(Sample = str_remove_all(ID, "[AB]")) %>%
  left_join(clinic, by = "Sample")

p <- list.map(
  c("Gender", "Ethnicity"),
  f(i, j) ~ {
    select(metadata, c(axis[1], i)) %>% 
    filter(!is.na(!!sym(i))) %>% 
    group_by(!!sym(i)) %>%
    group_split() %>%
    as.list() %>%
    list.map(f(i) ~ pull(i, 1)) %>%
    list_cbind() %>%
    round() %>%
    set_colnames(unique(pull(metadata, i)) %>% na.omit() %>% sort()) %>%
    plot_violin0(
        wrap = 5,
        wrap_title = 20,
        colour = brewer.pal(10, "Paired")[3:4 + 2 * j],
        color_title = brewer.pal(10, "Paired")[4 + 2 * j],
        stat = TRUE,
        title = i
    )
  }
)
list.map(
  c("Age", "BMI"),
  f(x, y) ~ select(metadata, c(axis[1], x)) %>% plot_cor2(color = get_colors()[y + 1], title = x)
) %>% c(p, .) %>%
plot_grid(
  plotlist = .,
  nrow = 2,
  ncol = 2,
  align = "hv"
)
list.map(
  c("Gender", "Ethnicity", "Age", "BMI"),
  f(var) ~ select(metadata, c(2:3, var)) %>% plot_dimred(axis, legend = var)
) %>%
  plot_grid(
  plotlist = .,
  nrow = 2,
  ncol = 2,
  align = "hv"
)
```

```{r pca}
res_pca <- PCA(t(norm_rna), scale.unit = FALSE, ncp = ncomp, graph = FALSE)
coord <- trans_coord(res_pca$ind$coord)
res_pca$eig[, "percentage of variance"] %>%
  plot_dimred(coord, axis, eig = .)
outs <- lapply(seq(ncomp), function(x) get_outliers(res$layout[, x], method = "iqr", replace = FALSE))
lapply(seq(ncomp), function(x) get_outliers(res_pca$ind$coord[, x], method = "mad", replace = FALSE, c = 6))
```

```{r mds}
hc_metric <- "pearson"
res_dist <- get_dist(t(norm_rna), stand = FALSE, method = hc_metric)

mds <- cmdscale(res_dist, k = ncomp, eig = TRUE)
mds$points[, 1] <- mds$points[, 1] * -1
(mds$eig / sum(mds$eig[mds$eig > 0]) * 100) %>%
  plot_dimred(trans_coord(mds$points), axis, eig = .)
```

```{r som}
som_grid <- somgrid(
    xdim = 3,
    ydim = 3,
    toroidal = TRUE,
    topo = "hexagonal"
)
res_som <- som(
    t(norm_rna0),
    grid = som_grid,
    rlen = 1000
)

col_grp <- function(x = som_clusters, a = 1) {
    x <- as.factor(x)
    levels(x) <- get_colors()[seq(levels(x))]
    return(as.vector(x))
}

plot(
    res_som,
    type = "mapping",
    cex = 0.8,
    labels = colnames(norm_rna),
    # cex = 3
    # labels = rep(".", ncol(norm_rna))
    col = col_grp(x = batch),
    bg = "white",
    shape = "straight",
    border = "gray50"
)
```

```{r ward}
res_clus <- hclust(res_dist, method = "ward.D2")
df <- as.matrix(res_dist)
annot <- data.frame(Batch = batch)
rownames(annot) <- rownames(t(norm_rna))
row_col <- get_colors()[c(1, 3:5, 2)] %>% set_names(unique(batch)) %>% list(Batch = .)
pheatmap(
    df,
    color = colorRampPalette(colors_ind)(100),
    angle_col = 315,
    na_col = "white",
    annotation_col = annot,
    border_color = NA,
    annotation_colors = row_col,
    cluster_rows = res_clus,
    cluster_cols = res_clus,
    cutree_rows = k,
    cutree_cols = k,
    fontsize = 12,
    show_rownames = FALSE,
    show_colnames = FALSE
)
```

```{r pam}
MAX_CLUSTERS <- 10
res_nhc <- getClassif(1, MAX_CLUSTERS, t(norm_rna), res_dist)
cls <- getClusterPerPart(MAX_CLUSTERS, res_nhc)
sil <- getSilhouette(cls[[k-1]], t(norm_rna))
heatMap(t(norm_rna), res_dist, sil, NULL, NULL)
```
