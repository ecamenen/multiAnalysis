---
title: "QC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(multiAnalysis)
set.seed(1)

plot_dimred <- function(
  coord,
  axis,
  eig = NULL,
  geom = "point",
  axis_text = FALSE,
  legend = "Batch",
  colour = get_colors(), 
  force = 0.2,
  alpha = 1,
  ...) {
    
  coord <- as.data.frame(coord) %>% set_colnames(c("x", "y", "var"))
  if (!is.null(eig)) {
      axis <- paste0(axis, " (", paste(round(eig[seq(2)], 1), "%)"))
  }
  p <- ggplot(coord, aes(x = x, y = y, color = var)) +
    geom_hline(yintercept = 0, size = .5, color = "gray70") +
    geom_vline(xintercept = 0, size = .5, color = "gray70") +
    labs(x = axis[1], y = axis[2], color = legend) +
    theme_minimal() +
    theme(
        axis.title = element_text(size = 15, face = "bold.italic", color = "gray50"),
        legend.title = element_text(size = 15, face = "bold.italic", color = "gray50"),
        legend.text = element_text(size = 13, color = "gray50")
    )
  if (pull(coord, "var") %>% is.numeric()) {
    p <- p + scale_color_gradientn(colors = c("darkblue", "#A6CEE3", "#FB9A99", "darkred"))
  } else {
    p <- p + 
      scale_color_manual(
        values = colour, 
        na.value = brewer.pal(n = 8, name = "Set2")[6]
      ) +
      guides(color = guide_legend(override.aes = list(shape = 15, size = 4)))
  }
    
  if (axis_text) {
    p <- p + theme(axis.text = element_text(size = 13, color = "gray50"))
  } else {
    p <- p + theme(axis.text = element_blank())
  }
  if (geom == "point") {
    p + geom_point(alpha = alpha)
  } else {
    p + geom_text_repel(aes(label = rownames(coord)), force = force, max.iter = 500, ..., alpha = alpha)
  }
}

trans_coord <- function(coord, add = NULL) {
  res <- as.data.frame(coord) %>% 
  set_colnames(axis)
  if (!is.null(add))
    res %>% mutate(batch = add)
  else
    res
}

ncomp <- 2
axis <- paste0("Dim. ", seq(ncomp))
```

```{r}
path <- golem::get_golem_wd()
cwd <- file.path(path, "inst", "extdata")
raw_counts <- read_tsv(file.path(cwd, "gene_counts.tsv")) %>% 
  column_to_rownames("gene_id")
batch <- read_tsv(file.path(cwd, "batch_rna.tsv")) %>% 
  mutate(batch = as.factor(batch))
batch <- data.frame(Sample = colnames(raw_counts)) %>% 
  full_join(batch, by = "Sample") %>% 
  column_to_rownames("Sample") %>% 
  pull(batch)
age0 <- interval(
    (complete_date(clinic$C_2648_3887) %>% dmy()),
    (complete_date(clinic$C_2643_3802) %>% dmy())
) / years(1)
clinic <- clinic %>% #read_tsv(file.path(cwd, "clinic.tsv")) %>% 
  select(c("C_2643_3796", "C_2649_3888", "C_2649_3895", "C_2643_3803", "C_2649_3890")) %>%
  set_colnames(c("Sample", "Gender", "Ethnicity", "Age", "BMI")) %>%
  mutate(Sample = as.numeric(Sample) %>% as.character()) %>%
  mutate(`Disease duration` = age0)
```
# Data
```{r data}
combat_counts <- as.matrix(raw_counts) %>%
    ComBat_seq(batch) %>%
    as.data.frame()
norm_rna0 <- round(raw_counts) %>% as.matrix() %>% vst()
colnames(norm_rna0) <- colnames(norm_rna0) %>% str_remove_all("05PB1")
norm_rna <- select(facs, !matches("(.*median.*)|(.*iqr.*)"))
batch <- blocks[[1]]$gender # pull(batch_facs, 1)
norm_rna1 <- apply(norm_rna, 2, function(x) {x[is.na(x)] <- median(x, na.rm = TRUE); x})
norm_rna <- round(combat_counts) %>% as.matrix() %>% vst()
colnames(norm_rna) <- colnames(norm_rna) %>% str_remove_all("05PB1")
# norm_rna0 <- apply(facs, 2, function(x) {x[is.na(x)] <- median(x, na.rm = TRUE); x})
norm_rna %>% as.data.frame() %>% 
  rownames_to_column("gene_id") %>% 
  write_tsv(file.path(path, "gene_nobatch_normalized.tsv"))

norm_rna0 <- counts(l_de0[[1]], normalized=TRUE) %>%
    round() %>%
    as.matrix()
```

# UMAP
```{r umap}
res <- umap(t(norm_rna0))
coord <- trans_coord(res$layout, add = batch)
plot_dimred(coord, axis)
metadata <- rownames_to_column(coord, "ID") %>% 
  mutate(Sample = str_remove_all(ID, "[AB].?")) %>%
  left_join(clinic, by = "Sample") %>%
  mutate(Group = blocks[[1]]$group)

x <- 1
p <- list.map(
  c("Gender", "Ethnicity"),
  f(i, j) ~ {
    select(metadata, c(axis[x], i)) %>% 
    filter(!is.na(!!sym(i))) %>% 
    group_by(!!sym(i)) %>%
    group_split() %>%
    as.list() %>%
    list.map(f(i) ~ pull(i, 1)) %>%
    list_cbind0() %>%
    round() %>%
    set_colnames(unique(pull(metadata, i)) %>% na.omit() %>% sort()) %>%
    plot_violin(
        method  = "wilcox",
        width_text = 5,
        width_title = 20,
        colour = brewer.pal(10, "Paired")[3:4 + 2 * j],
        color_title = brewer.pal(10, "Paired")[4 + 2 * j],
        stats = TRUE,
        title = i
    ) +
      theme(plot.subtitle = element_text(hjust = 0.5, size = 17))
  }
)

mod <- lm(`Dim. 1` ~ Gender * Group, data = metadata)
summary(mod)

p2 <- list.map(
  c("Gender", "Ethnicity"),
  f(i, j) ~ {
    lapply(
      unique(pull(metadata, i)) %>% na.omit(),
      function(var) {
        select(metadata, c(axis[x], i, Group)) %>% 
        filter(!is.na(!!sym(i))) %>%
        filter(!!sym(i) == var) %>%
        group_by(Group) %>%
        group_split() %>%
        as.list() %>%
        list.map(f(i) ~ pull(i, 1)) %>%
        list_cbind0() %>%
        round() %>%
        set_colnames(c("HV", "SD")) %>%
        plot_violin(
            method  = "wilcox",
            width_text = 5,
            width_title = 20,
            colour = get_colors()[c(5, 3)],
            color_title = "black",
            stats = TRUE,
            title = var
        ) +
          theme(plot.subtitle = element_text(hjust = 0.5, size = 17))
      }
    ) %>%
      plot_grid(
        plotlist = .,
        ncol = 2,
        align = "hv"
      )
  }
)
list.map(
  c("Age", "BMI"),
  f(i, j) ~ select(metadata, c(axis[x], i)) %>% plot_cor2(color = get_colors()[j + 1], title = i)
) %>% c(p, .) %>%
plot_grid(
  plotlist = .,
  nrow = 2,
  ncol = 2
)

list.map(
  c("Age", "Disease duration", "BMI"),
  f(i, j) ~ {
    list.map(
      unique(pull(metadata, "Group")),
      f(x) ~ {
    filter(metadata, Group == x) %>%
      select(c(axis[x], i)) %>% 
      plot_cor2(color = get_colors()[j + 1], title = x)
      }
    ) %>%
      plot_grid(
        plotlist = .,
        ncol = 2,
        align = "hv"
      )
  }
)

plot_grid(
  plotlist = .,
  nrow = 2,
  ncol = 2
)

list.map(
  c("Gender", "Ethnicity", "Age", "BMI"),
  f(var) ~ select(c(2:3, var)) %>% plot_dimred(axis, legend = var)
) %>%
  plot_grid(
  plotlist = .,
  nrow = 2,
  ncol = 2,
  align = "hv"
)

select(metadata, c(2:3, Group)) %>% mutate(Group = ifelse(Group == 0, "HV", "SD")) %>% plot_dimred(axis, eig = eig, legend = "Group", colour = get_colors()[c(5, 3)]) + theme(legend.position = "none")
```

# PCA
```{r pca}
res_pca <- PCA(norm_rna1, scale.unit = FALSE, ncp = ncomp, graph = FALSE)
coord <- trans_coord(res_pca$ind$coord, add = batch)
res_pca$eig[, "percentage of variance"] %>%
  plot_dimred(coord, axis, eig = .)
outs <- lapply(seq(ncomp), function(x) get_outliers(res$layout[, x], method = "iqr", replace = FALSE))
lapply(seq(ncomp), function(x) get_outliers(res_pca$ind$coord[, x], method = "mad", replace = FALSE, c = 6))
```

# RGCCA
```{r}
res_rgcca <- rgcca(norm_rna, ncomp = 5, method = "pca", scale = FALSE, scale_block = FALSE)
coord <- trans_coord(res_rgcca$Y[[1]][, seq(ncomp)], add = batch)
(res_rgcca$AVE$AVE_outer * 100) %>%
  plot_dimred(coord, axis, eig = .)
(coord[, 1] - min(coord[, 1])) %>% cbind(pull(batch, 1)) %>% chisq_test(workspace = 1e8)
rgcca_weights <- res_rgcca$a[[1]]
dim <- 1
title <- (res_rgcca$AVE$AVE_outer * 100) %>% 
  round(0) %>%
  paste0("%") %>%
  .[dim]
# c("#99000D", "gray")
abs(rgcca_weights[, dim] * 100) %>% 
  plot_bar(
    n_max = 15,
    cex = 0.7,
    colour =  c("#99000D", "gray"), # ifelse(rgcca_weights[, dim] < 0, "darkred", "forestgreen"),
    width_text = 40,
    title = paste0("Dim. ", dim, ": ", title)
)
```

# MDS
```{r mds}
hc_metric <- "spearman"
norm_rna2 <- t(norm_rna0) %>% remove_constant() %>% scale()
res_dist <- norm_rna2 %>% get_dist(stand = FALSE, method = hc_metric)

mds <- cmdscale(res_dist, k = ncomp, eig = TRUE, x.ret = TRUE)
# mds <- cmdscale(1 - rf$proximity, k = ncomp, eig = TRUE)
mds$points[, 1] <- mds$points[, 1] * -1
coord <- trans_coord(mds$points, add = batch)
eig <- (mds$eig / sum(mds$eig) * 100) #[mds$eig > 0]
  plot_dimred(coord, axis, eig = eig, colour = get_colors()[c(3, 5)]) + 
  theme(legend.position = "none")
lapply(
  unique(batch), 
  function(x) {
    filter(coord, batch == x) %>% arrange(`Dim. 1`)
    }
  )
```

# SOM
```{r som}
som_grid <- somgrid(
    xdim = 3,
    ydim = 3,
    toroidal = TRUE,
    topo = "hexagonal"
)
res_som <- som(
    facs %>% as.matrix(),
    grid = som_grid,
    rlen = 10000,
    normalizeDataLayers = FALSE,
    maxNA.fraction = 101
)

col_grp <- function(x = som_clusters, a = 1, color = get_colors()) {
    x <- as.factor(x)
    levels(x) <- color[seq(levels(x))]
    return(as.vector(x))
}

plot(
    res_som,
    type = "mapping",
    cex = 0.8,
    # labels = colnames(facs),
    # cex = 3
    # labels = rep(".", ncol(norm_rna))
    col = col_grp(x = batch),
    bg = "white",
    shape = "straight",
    border = "gray50"
)
add.cluster.boundaries(som_model, som_clusters, lwd = 5, col = "white")
```

# HAC
```{r ward}
res_clus <- hclust(res_dist, method = "ward.D2")
df <- as.matrix(res_dist)
annot <- data.frame(Batch = batch)
rownames(annot) <- rownames(facs)
row_col <- get_colors()[c(1, 3:5, 2)] %>% set_names(unique(batch)) %>% list(Batch = .)
pheatmap(
    df,
    color = colorRampPalette(colors_ind)(100),
    angle_col = 315,
    na_col = "white",
    annotation_col = annot,
    border_color = NA,
    annotation_colors = row_col,
    cluster_rows = res_clus,
    cluster_cols = res_clus,
    cutree_rows = k,
    cutree_cols = k,
    fontsize = 12,
    show_rownames = FALSE,
    show_colnames = FALSE
)
```

# NHC
```{r pam}
MAX_CLUSTERS <- 10
res_nhc <- getClassif(1, MAX_CLUSTERS, t(norm_rna), res_dist)
cls <- getClusterPerPart(MAX_CLUSTERS, res_nhc)
sil <- getSilhouette(cls[[k-1]], t(norm_rna))
heatMap(t(norm_rna), res_dist, sil, NULL, NULL)
```
