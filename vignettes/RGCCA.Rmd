---
title: "RGCCA"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RGCCA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

# Setup
```{r setup}
library(multiAnalysis)
set_analysis(block_name = "rna_clinic_still2", type = "list", to_remove = c("1007", "1014", "9001"))
load_all(path = file.path(golem::get_golem_wd(), "inst", "RGCCA"))
n <- length(blocks)
ncomp <- 2
```

# Model
```{r model}
res <- rgcca(blocks, ncomp = ncomp, response = n, sparsity = c(1, 0.1)) # tau = "optimal"
plot_ave(res, cex = 1.8, title = "")
RGCCA::plot_network2(res, colors = c("gray", "gray"))

sapply(ncol(res$a[[2]]), function(i) res$a[[2]][, i] != 0) %>%
    which() %>%
    length()

# Y <- res$Y[[1]][, 1]
```

# Variable
```{r var}
plot_var_2D(
    res,
    cex_main = 30,
    cex_lab = 20,
    no_overlap = TRUE,
    i_block = n
)
plot_var_2D(
    res,
    i_block = 1,
    cex_main = 30,
    cex_lab = 20,
    no_overlap = TRUE,
    cex = 1.5,
    n_mark = 10,
    colors = get_colors()[1]
)
plot_var_2D(
    res,
    i_block = 2,
    cex_main = 30,
    cex_lab = 20,
    no_overlap = TRUE
)
```

# Stats
```{r stats}
table_occ <- function(x, i, y) {
    sapply(
        y,
        function(j) {
            nrow(
                filter(
                    x,
                    str_detect(
                        as.data.frame(x[, i])[, 1], replace_parenthesis(j)
                    )
                ) %>%
                    select(all_of(i))
            )
        }
    )
}

replace_parenthesis <- function(x) {
    str_replace_all(x, "\\(", "\\\\(") %>%
        str_replace_all("\\)", "\\\\)")
}

clinic_intersect$disease <- as.character(clinic_intersect$disease)

tab_diseases <- table_occ(
    clinic_intersect,
    "disease",
    unique(sort((
        clinic_intersect$disease
    )))
)
levels <- tab_diseases[as.numeric(tab_diseases) >= 5]

tab_gender <- table_occ(
    clinic_intersect,
    "gender",
    unique(sort((
        clinic_intersect$gender
    )))
)
```

# Indivduals
```{r ind}
Reduce(cbind, res$Y) %>%
    set_colnames(paste0(rep(c("Clinic", "RNA"), each = 2), ": Dim.", seq(2))) %>%
    t() %>%
    corrplot(is.corr = FALSE, col = colorRampPalette(colors_ind)(100))

plot_ind0 <- function(
    x,
    colors = get_colors(),
    no_overlap = TRUE,
    text = FALSE,
    i_block = n
) {
    if (text) {
        no_overlap <- FALSE
    }
    plot_ind(
        res,
        i_block = i_block,
        cex_main = 30,
        cex_lab = 20,
        no_overlap = no_overlap,
        resp = as.data.frame(clinic_intersect[, x])[[1]],
        response_name = str_to_title(x),
        text = text,
        colors = colors
    )
}

plot_ind0("disease", i_block = 1, text = FALSE)

clinic_intersect <- mutate(
    clinic_intersect,
    diseases = case_when(
        !str_detect(
            disease,
            paste(replace_parenthesis(names(levels)), collapse = "|")
        ) ~ "Others",
        TRUE ~ disease
    )
)

colors <- c(
    rgb(255 / 255, 0 / 255, 0 / 255, 0.5),
    rgb(255 / 255, 204 / 255, 0 / 255, 0.5),
    rgb(0 / 255, 255 / 255, 0 / 255, 0.5),
    rgb(102 / 255, 153 / 255, 255 / 255, 0.5),
    rgb(204 / 255, 51 / 255, 255 / 255, 0.5),
    rgb(153 / 255, 153 / 255, 30 / 255, 0.5),
    rgb(0, 0, 0, 0.5)
)
# toRGB(c(pal_ucscgb()(7)[-2], "black"), 0.5)

plot_ind0("diseases", colors = get_colors(), text = TRUE)
```

# Biplot
```{r biplot}
ctr <- RGCCA:::get_ctr2(
    rgcca_res = res,
    compx = 1,
    compy = 2,
    i_block = 1,
    type = "loadings",
    n_mark = 100,
    remove_var = FALSE
) %>% mutate(
    top1 = ncol(blocks[[1]]) - (abs(X1) %>% row_number()) + 1,
    top2 = ncol(blocks[[1]]) - (abs(X2) %>% row_number()) + 1,
    name = colnames(blocks[[1]])
)
top_var <- bind_cols(
    ctr %>% arrange(top1) %>% head(10) %>% pull(name),
    ctr %>% arrange(top2) %>% head(10) %>% pull(name)
)
res_pca <- PCA(blocks[[1]], scale.unit = TRUE, ncp = 3, graph = FALSE)
res_pca$ind$coord <- res$Y[[1]]
res_pca$var$coord <- ctr[, seq(2)]
res_pca$var$contrib <- abs(ctr[, seq(2)])
res_pca$eig[seq(ncomp), 2] <- (res$AVE[[1]][[1]] * 100) %>% t() %>% t()
# res_pca$var$contrib[ pull(top_var, 2), "X1"] <- res_pca$var$contrib[ pull(top_var, 2), "X2"]
# theme_perso_2D(
#     fviz_pca_var(
#         res_pca,
#         col.var = "contrib",
#         repel = TRUE,
#         gradient.cols = colPers,
#         select.var = list(name = unlist(top_var))
#     )
# )

theme_perso_2D(
    fviz_pca_biplot(
        res_pca,
        repel = TRUE,
        col.var = "contrib",
        gradient.cols = c("gray", get_colors()[1]),
        # alpha.var = "contrib",
        col.ind = "gray",
        # palette = function (i) {c("red", "gray")},
        # pointsize = "cos2",
        mean.point = FALSE,
        select.var = list(name = unlist(top_var))
    ) +
        labs(fill = "Contribution")
)
```

# Bootstrap
```{r boot}
# eval <- rgcca_cv_k(res, validation = "loo")
n_boot <- 1000
# bb <- bootstrap(res, n_boot = n_boot)
file_boot <- "bootstrap_still_rna_clinic.RData"
# use_data(bb, file = file_boot, overwrite = TRUE)
load(file.path(path, file_boot))
top_var <- get_bootstrap(bb, type = "loadings")
top_genes <- top_var %>%
    data.frame() %>%
    mutate(name = rownames(top_var)) %>%
    tibble() %>%
    arrange(desc(bootstrap_ratio)) %>%
    filter(adjust.pval <= 0.05)
# plot_bootstrap_2D(df_b = top_var, y = "occurences")
plot_bootstrap_1D(df_b = top_var, x = "bootstrap_ratio", display_bar = FALSE, y = "bootstrap_ratio")
plot_bootstrap_1D(df_b = top_var, x = "bootstrap_ratio", display_bar = FALSE, y = "sign", n_mark = 100)
```
